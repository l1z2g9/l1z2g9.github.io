<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="utf-8">
  
  <title>PDF Signing By p12 With JS | My Blog</title>
  <meta name="author" content="Forrest Wan">
  
  <meta name="description" content="My Blog">
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="PDF Signing By p12 With JS"/>
  <meta property="og:site_name" content="My Blog"/>

  
    <meta property="og:image" content=""/>
  

  <link rel="shortcut icon" href="/favicon.png">
  
  
<link rel="stylesheet" href="/css/style.css">

  <!--[if lt IE 9]><script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script><![endif]-->
  

<meta name="generator" content="Hexo 6.1.0"></head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">My Blog</a></h1>
  <h2><a href="/"></a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/null">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article id="post-PDF_Signing_By_p12_With_JS" class="h-entry post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time class="dt-published" datetime="2019-01-23T08:20:53.000Z"><a href="/2019/01/23/PDF_Signing_By_p12_With_JS/">2019-01-23</a></time>
      
      
  
    <h1 class="p-name title" itemprop="headline name">PDF Signing By p12 With JS</h1>
  

    </header>
    <div class="e-content entry" itemprop="articleBody">
      
        <h2 id="DocSignController-java"><a href="#DocSignController-java" class="headerlink" title="DocSignController.java"></a>DocSignController.java</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br></pre></td><td class="code"><pre><span class="line">@GetMapping(&quot;/doc-sign/sign&quot;)</span><br><span class="line">public ResponseEntity&lt;Resource&gt; getHashForSign() throws IOException &#123;</span><br><span class="line">    log.debug(&quot;start to generate merged PDF in java web start program&quot;);</span><br><span class="line">    synchronized (eventPublisher) &#123;</span><br><span class="line">        eventPublisher.publishEvent(new OnDocMergeEvent(getUserId(), getXxxFormMaster().getXxxFormMasterId(), getXxxFormMaster().getFormType()));</span><br><span class="line">    &#125;</span><br><span class="line">    Integer xxxFormMasterId = getXxxFormMaster().getXxxFormMasterId();</span><br><span class="line">    String userId = getUserId();</span><br><span class="line"></span><br><span class="line">    List&lt;SuppDoc&gt; suppDocs = suppDocMapper.selectSuppDocByXxxFormMasterIdAndDocTypeAndUserId(xxxFormMasterId, userId, Constants.SUPP_DOC_TYPE_SYS_GEN_MERGE);</span><br><span class="line">    if (suppDocs == null || suppDocs.isEmpty()) &#123;</span><br><span class="line">        suppDocs = suppDocMapper.selectSuppDocByXxxFormMasterIdAndDocTypeAndUserId(xxxFormMasterId, userId, Constants.SUPP_DOC_TYPE_SYS_SIGN);</span><br><span class="line">        if (suppDocs != null &amp;&amp; !suppDocs.isEmpty()) &#123;</span><br><span class="line">            log.info(&quot;signed doc exists !!&quot;);</span><br><span class="line">            return ResponseEntity.status(HttpStatus.NOT_ACCEPTABLE).body(null);</span><br><span class="line">        &#125;</span><br><span class="line">        return ResponseEntity.status(HttpStatus.NOT_FOUND).body(null);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SuppDoc suppDoc = suppDocs.get(0);</span><br><span class="line">    Integer suppDocId = suppDoc.getSuppDocId();</span><br><span class="line"></span><br><span class="line">    Resource pdfFile = storageService.loadAsResource(xxxFormMasterId, suppDocId);</span><br><span class="line"></span><br><span class="line">    File tempPdfFile = File.createTempFile(&quot;tmp&quot;, &quot;.pdf&quot;);</span><br><span class="line">    log.debug(&quot;Prepare pdf file for sign: &#123;&#125;&quot;, tempPdfFile.getPath());</span><br><span class="line"></span><br><span class="line">    log.info(&quot;get hash for sign, userId &#123;&#125; form master id &#123;&#125;&quot;, userId, xxxFormMasterId);</span><br><span class="line"></span><br><span class="line">    InputStream is = null;</span><br><span class="line">    try &#123;</span><br><span class="line">        is = emptySignature(pdfFile.getInputStream(), tempPdfFile);</span><br><span class="line">    &#125; catch (DocumentException | GeneralSecurityException e) &#123;</span><br><span class="line">        log.error(&quot;error occurrs on calculate signature&quot;, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    byte[] encryptedEmptySig = encrypt(StreamUtils.copyToByteArray(is));</span><br><span class="line">    //byte[] emptySig = StreamUtils.copyToByteArray(is);</span><br><span class="line">    String emptySig = Base64.getEncoder().encodeToString(encryptedEmptySig);</span><br><span class="line"></span><br><span class="line">    ByteArrayResource resource = new ByteArrayResource(emptySig.getBytes(StandardCharsets.ISO_8859_1));</span><br><span class="line"></span><br><span class="line">    HttpHeaders headers = new HttpHeaders();</span><br><span class="line">    headers.add(&quot;Cache-Control&quot;, &quot;no-cache, no-store, must-revalidate&quot;);</span><br><span class="line">    headers.add(&quot;Pragma&quot;, &quot;no-cache&quot;);</span><br><span class="line">    headers.add(&quot;Expires&quot;, &quot;0&quot;);</span><br><span class="line"></span><br><span class="line">    request.getSession(false).setAttribute(TEMP_SIGN_PATH, tempPdfFile.getPath());</span><br><span class="line"></span><br><span class="line">    return ResponseEntity.ok()</span><br><span class="line">            .headers(headers)</span><br><span class="line">            .contentLength(resource.contentLength())</span><br><span class="line">            .contentType(MediaType.TEXT_PLAIN)</span><br><span class="line">            .body(resource);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private byte[] encrypt(byte[] emptySig) &#123;</span><br><span class="line">    /*try &#123;</span><br><span class="line">        log.debug(&quot;js debugging for signing with forge&quot;)</span><br><span class="line">        log.debug(&quot;HexBin.encode(emptySig) &quot; + HexBin.encode(emptySig).substring(0, 500));</span><br><span class="line">        MessageDigest messageDigest = MessageDigest.getInstance(&quot;SHA-256&quot;);</span><br><span class="line">        byte hash[] = messageDigest.digest(emptySig);</span><br><span class="line">        System.out.println(&quot;server emptySig sha256 hash = &quot; + Hex.toHexString(hash));</span><br><span class="line">    &#125; catch (NoSuchAlgorithmException e1) &#123;</span><br><span class="line">    &#125;*/</span><br><span class="line"></span><br><span class="line">    String type = &quot;X.509&quot;;</span><br><span class="line"></span><br><span class="line">    String encodedCertificate = request.getParameter(&quot;certificate&quot;);</span><br><span class="line">    try &#123;</span><br><span class="line">        CertificateFactory certificateFactory = CertificateFactory.getInstance(type);</span><br><span class="line">        Certificate certificate = certificateFactory.generateCertificate(</span><br><span class="line">                new ByteArrayInputStream(HashUtils.base64Decode(encodedCertificate)));</span><br><span class="line">        PublicKey publicKey = certificate.getPublicKey();</span><br><span class="line"></span><br><span class="line">        Cipher rsaCipher;</span><br><span class="line">        try &#123;</span><br><span class="line">            rsaCipher = Cipher.getInstance(RSA_ALGORITHM);</span><br><span class="line">            rsaCipher.init(Cipher.ENCRYPT_MODE, publicKey);</span><br><span class="line"></span><br><span class="line">            // reference from https://stackoverflow.com/questions/24338108/java-encrypt-string-with-existing-public-key-file</span><br><span class="line">            // Now create a new 256 bit Rijndael key to encrypt the file itself.</span><br><span class="line">            // This will be the session key.</span><br><span class="line">            /*KeyGenerator rijndaelKeyGenerator = KeyGenerator.getInstance(&quot;Rijndael&quot;);</span><br><span class="line">            rijndaelKeyGenerator.init(256);</span><br><span class="line">            log.debug(&quot;Generating session key...&quot;);</span><br><span class="line">            Key rijndaelKey = rijndaelKeyGenerator.generateKey();</span><br><span class="line">            log.debug(&quot;Done generating key.&quot;);</span><br><span class="line">            </span><br><span class="line">            byte[] encodedKeyBytes = rsaCipher.doFinal(rijndaelKey.getEncoded());</span><br><span class="line">            ByteArrayOutputStream output = new ByteArrayOutputStream();</span><br><span class="line">            output.write(encodedKeyBytes.length);</span><br><span class="line">            output.write(encodedKeyBytes);</span><br><span class="line">            </span><br><span class="line">            // Now we need an Initialization Vector for the symmetric cipher in CBC mode</span><br><span class="line">            SecureRandom random = new SecureRandom();</span><br><span class="line">            byte[] iv = new byte[16];</span><br><span class="line">            random.nextBytes(iv);</span><br><span class="line">            </span><br><span class="line">            output.write(iv);</span><br><span class="line">            </span><br><span class="line">            IvParameterSpec spec = new IvParameterSpec(iv);</span><br><span class="line">            // Create the cipher for encrypting the file itself.</span><br><span class="line">            Cipher symmetricCipher = Cipher.getInstance(RIJNDAEL_ALGORITHM);</span><br><span class="line">            symmetricCipher.init(Cipher.ENCRYPT_MODE, rijndaelKey, spec);</span><br><span class="line">            */</span><br><span class="line"></span><br><span class="line">            ByteArrayOutputStream baos = new ByteArrayOutputStream();</span><br><span class="line">            DataOutputStream output = new DataOutputStream(baos);</span><br><span class="line"></span><br><span class="line">            KeyGenerator generator = KeyGenerator.getInstance(&quot;AES&quot;);</span><br><span class="line">            generator.init(128);</span><br><span class="line">            log.debug(&quot;Generating session key...&quot;);</span><br><span class="line">            SecretKey aesKey = generator.generateKey();</span><br><span class="line">            log.debug(&quot;Done generating key.&quot;);</span><br><span class="line"></span><br><span class="line">            log.debug(&quot;aesKey.getEncoded() = &quot; + Base64.getEncoder().encodeToString(aesKey.getEncoded()));</span><br><span class="line">            byte[] encodedKeyBytes = rsaCipher.doFinal(aesKey.getEncoded());</span><br><span class="line"></span><br><span class="line">            // output = encrypted AES key length + encrypted AES key + empty signature encrypted by AES key</span><br><span class="line">            log.debug(&quot;encrypted AES key length = &quot; + encodedKeyBytes.length);</span><br><span class="line">            output.writeInt(encodedKeyBytes.length);</span><br><span class="line">            output.write(encodedKeyBytes);</span><br><span class="line"></span><br><span class="line">            Cipher symmetricCipher = Cipher.getInstance(AES_ALGORITHM);</span><br><span class="line">            symmetricCipher.init(Cipher.ENCRYPT_MODE, aesKey);</span><br><span class="line"></span><br><span class="line">            output.write(symmetricCipher.doFinal(emptySig));</span><br><span class="line">            output.flush();</span><br><span class="line"></span><br><span class="line">            log.debug(&quot;length of encrypted data = &quot; + baos.toByteArray().length);</span><br><span class="line">            return baos.toByteArray();</span><br><span class="line">        &#125; catch (NoSuchAlgorithmException | NoSuchPaddingException | InvalidKeyException</span><br><span class="line">                | IllegalBlockSizeException | BadPaddingException | IOException e) &#123;</span><br><span class="line">            log.error(&quot;encrypt empty signature&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (CertificateException e) &#123;</span><br><span class="line">        log.error(&quot;encrypt&quot;, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private InputStream emptySignature(InputStream src, File dest)</span><br><span class="line">        throws IOException, DocumentException, GeneralSecurityException &#123;</span><br><span class="line">    PdfReader reader = new PdfReader(src);</span><br><span class="line">    FileOutputStream os = new FileOutputStream(dest);</span><br><span class="line">    PdfStamper stamper = PdfStamper.createSignature(reader, os, &#x27;\0&#x27;);</span><br><span class="line">    PdfSignatureAppearance appearance = stamper.getSignatureAppearance();</span><br><span class="line"></span><br><span class="line">    //appearance.setVisibleSignature(new Rectangle(0, 0, 0, 0), 1, FIELD_NAME);</span><br><span class="line">    log.info(&quot;create empty signature&quot;);</span><br><span class="line">    String position = (String) WebUtils.getSession().getAttribute(WebAttributeNames.SESSION_TCSP_DOC_SIGNATURE_POSITION);</span><br><span class="line">    String[] p = position.split(&quot;\\|&quot;);</span><br><span class="line">    appearance.setVisibleSignature(new Rectangle(Float.valueOf(p[0]), Float.valueOf(p[1]), Float.valueOf(p[2]), Float.valueOf(p[3])), Integer.valueOf(p[4]), Constants.SIG_FIELD_NAME);</span><br><span class="line"></span><br><span class="line">    // set signature text</span><br><span class="line">    Font font = new Font(FontFamily.TIMES_ROMAN, 10, Font.BOLD);</span><br><span class="line">    appearance.setLayer2Font(font);</span><br><span class="line">    appearance.setRunDirection(PdfWriter.RUN_DIRECTION_RTL);</span><br><span class="line"></span><br><span class="line">    appearance.setLayer2Text(&quot;Signed By Digital Certificate&quot;);</span><br><span class="line"></span><br><span class="line">    ClassPathResource pinImage = new ClassPathResource(&quot;static/images/Cert-sign.png&quot;);</span><br><span class="line">    appearance.setImage(Image.getInstance(pinImage.getURL()));</span><br><span class="line"></span><br><span class="line">    //appearance.setCertificate(chain[0]);</span><br><span class="line">    ExternalSignatureContainer external = new ExternalBlankSignatureContainer(PdfName.ADOBE_PPKLITE,</span><br><span class="line">            PdfName.ADBE_PKCS7_DETACHED);</span><br><span class="line">    MakeSignature.signExternalContainer(appearance, external, 8192);</span><br><span class="line">    os.close();</span><br><span class="line">    return appearance.getRangeStream();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@PostMapping(value = &quot;/doc-sign/sign&quot;, produces = MediaType.APPLICATION_JSON_VALUE)</span><br><span class="line">@ResponseBody</span><br><span class="line">public CertSignResult attachSignedHash() &#123;</span><br><span class="line">    CertSignResult certSignResult = new CertSignResult();</span><br><span class="line">    certSignResult.setStatus(CertSignResult.STATUS_NOT_SIGNED);</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        if (!WebUtils.validateCert(pkiClient)) &#123;</span><br><span class="line">            return certSignResult;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        log.error(&quot;signHash&quot;, e);</span><br><span class="line">        return certSignResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String tempPath = (String) request.getSession(false).getAttribute(TEMP_SIGN_PATH);</span><br><span class="line"></span><br><span class="line">    Integer xxxFormMasterId = getXxxFormMaster().getXxxFormMasterId();</span><br><span class="line">    String userId = getUserId();</span><br><span class="line"></span><br><span class="line">    log.info(&quot;sign hash, userId &#123;&#125; form master id &#123;&#125;&quot;, userId, xxxFormMasterId);</span><br><span class="line"></span><br><span class="line">    //		tryToDeleteSignedDoc();</span><br><span class="line"></span><br><span class="line">    File tempSignedFile = null;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        tempSignedFile = File.createTempFile(&quot;signed-&quot; + xxxFormMasterId + &quot;-&quot;, &quot;.pdf&quot;);</span><br><span class="line"></span><br><span class="line">        String hash = request.getParameter(&quot;signed&quot;);</span><br><span class="line">        //log.debug(&quot;hash &#123;&#125;&quot;, hash);</span><br><span class="line">        // Save the hash to file pkcs7-hash.pem</span><br><span class="line">        // View p7 file content by: openssl asn1parse -inform pem -in pkcs7-hash.pem</span><br><span class="line"></span><br><span class="line">        byte[] signedhash = Base64.getDecoder().decode(hash);</span><br><span class="line"></span><br><span class="line">        createSignature(tempPath, tempSignedFile, signedhash);</span><br><span class="line">    &#125; catch (DocumentException | GeneralSecurityException | IOException e) &#123;</span><br><span class="line">        log.error(&quot;Fail to sign document &quot; + e);</span><br><span class="line">        return certSignResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SimpleSuppDoc doc = new SimpleSuppDoc();</span><br><span class="line">    doc.setXxxFormMasterId(xxxFormMasterId);</span><br><span class="line">    doc.setLocalFile(tempSignedFile);</span><br><span class="line">    doc.setSuppDocType(Constants.SUPP_DOC_TYPE_SYS_SIGN);</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        Integer suppDocId = storageService.store(doc, userId);</span><br><span class="line"></span><br><span class="line">        if (doc.isUploadSucess()) &#123;</span><br><span class="line">            insertSigningLog(userId, xxxFormMasterId, suppDocId);</span><br><span class="line"></span><br><span class="line">            // no need to keep the merged doc</span><br><span class="line">            storageService.deleteDocByUserIdAndType(xxxFormMasterId, userId, Constants.SUPP_DOC_TYPE_SYS_GEN_MERGE);</span><br><span class="line"></span><br><span class="line">            certSignResult.setStatus(CertSignResult.STATUS_SIGNED);</span><br><span class="line">            request.getSession(false).setAttribute(WebAttributeNames.SESSION_TCSP_DOC_SIGN_STATUS, certSignResult);</span><br><span class="line"></span><br><span class="line">            createZipFileForSignedDoc(userId, tempSignedFile);</span><br><span class="line">            return certSignResult;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (IOException e) &#123;</span><br><span class="line">        log.error(&quot;sign pdf file&quot;, e);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        if (tempSignedFile != null)</span><br><span class="line">            tempSignedFile.delete();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return certSignResult;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private void createSignature(String src, File dest, byte[] signedHash)</span><br><span class="line">        throws IOException, DocumentException, GeneralSecurityException &#123;</span><br><span class="line">    PdfReader reader = new PdfReader(src);</span><br><span class="line">    FileOutputStream os = new FileOutputStream(dest);</span><br><span class="line">    ExternalSignatureContainer external = new MyExternalSignatureContainer(signedHash);</span><br><span class="line">    MakeSignature.signDeferred(reader, Constants.SIG_FIELD_NAME, os, external);</span><br><span class="line">    os.close();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class MyExternalSignatureContainer implements ExternalSignatureContainer &#123;</span><br><span class="line">    protected byte[] sig;</span><br><span class="line"></span><br><span class="line">    public MyExternalSignatureContainer(byte[] sig) &#123;</span><br><span class="line">        this.sig = sig;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void modifySigningDictionary(PdfDictionary signDic) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public byte[] sign(InputStream arg0) throws GeneralSecurityException &#123;</span><br><span class="line">        return sig;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="JS-for-PDF-signing"><a href="#JS-for-PDF-signing" class="headerlink" title="JS for PDF signing"></a>JS for PDF signing</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line">function signAndSubmit() &#123;</span><br><span class="line">  console.log(&quot;signAndSubmit&quot;)</span><br><span class="line"></span><br><span class="line">  var idType = $(&quot;:radio[name=&#x27;idType&#x27;]:checked&quot;).val();</span><br><span class="line">  var hkid = $(&quot;#hkid&quot;).val();</span><br><span class="line">  var hkidCheckDigit = $(&quot;#hkidCheckDigit&quot;).val();</span><br><span class="line">  var passport = $(&quot;#passport&quot;).val()</span><br><span class="line">  var file = document.getElementById(&quot;filename&quot;).files[0];</span><br><span class="line"></span><br><span class="line">  if (!checkInput(idType, hkid, hkidCheckDigit, passport, file))</span><br><span class="line">    return false;</span><br><span class="line"></span><br><span class="line">  var password = $(&quot;#pin&quot;).val();</span><br><span class="line">  console.log(&quot;password &quot; + password)</span><br><span class="line"></span><br><span class="line">  //Reading certificate from a &#x27;file&#x27; form field</span><br><span class="line">  var reader = new FileReader();</span><br><span class="line">  reader.onload = function (e) &#123;</span><br><span class="line">    var contents = e.target.result;</span><br><span class="line"></span><br><span class="line">    var pkcs12 = loadFile(password, contents);</span><br><span class="line">    if(!pkcs12)&#123;</span><br><span class="line">      showError(ErrorCode.INVALID_PIN);</span><br><span class="line">      return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    extractInfo(pkcs12, idType, hkid, hkidCheckDigit, passport).then(function (info) &#123;</span><br><span class="line">      var data = &#123;</span><br><span class="line">        signature: info.signature,</span><br><span class="line">        // certLogin: &quot;1&quot;,</span><br><span class="line">        certificate: info.certificate,</span><br><span class="line">        hkid: hkid + &quot;:&quot; + hkidCheckDigit,</span><br><span class="line">        passport: passport,</span><br><span class="line">        idType: idType,</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">        type: &#x27;GET&#x27;,</span><br><span class="line">        url: resetStatusUrl + &quot;?keep-challenge=1&quot;,</span><br><span class="line">        dataType: &#x27;json&#x27;,</span><br><span class="line">        async: false,</span><br><span class="line">        success: function(result) &#123;</span><br><span class="line">            if (result == 0) &#123;</span><br><span class="line">                console.log(&quot;start to do signing for the PDF&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        error: function(exception) &#123;</span><br><span class="line">          window.location.href = errPath;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    $.get(validateUserUrl, &#123; hkid: data.hkid, passport: data.passport, idType: data.idType &#125;).done(function (result) &#123;</span><br><span class="line">        if (result == &#x27;T&#x27;) &#123;</span><br><span class="line">          $.get(signAndSubmitUrl, &#123; certificate: data.certificate &#125;).done(function (signature) &#123;</span><br><span class="line">            console.log(&quot;signature = &quot; + signature.length);</span><br><span class="line">            var ciphertext = forge.util.decode64(signature);</span><br><span class="line"></span><br><span class="line">            var buffer = forge.util.createBuffer(ciphertext, &#x27;binary&#x27;);</span><br><span class="line"></span><br><span class="line">            var aesKeyLength = buffer.getInt32();</span><br><span class="line">            console.log(&quot;aesKeyLength = &quot; + aesKeyLength);</span><br><span class="line"></span><br><span class="line">            var encryptedAesKey = buffer.getBytes(aesKeyLength);</span><br><span class="line">            console.dir(encryptedAesKey);</span><br><span class="line"></span><br><span class="line">            var aesKey = privateKey.decrypt(encryptedAesKey);</span><br><span class="line">            console.log(&quot;decrypted aesKey = &quot; + forge.util.encode64(aesKey));</span><br><span class="line"></span><br><span class="line">            var decipher = forge.cipher.createDecipher(&#x27;AES-ECB&#x27;, aesKey);</span><br><span class="line">            decipher.start();</span><br><span class="line">            decipher.update(forge.util.createBuffer(buffer.getBytes()));</span><br><span class="line"></span><br><span class="line">            var result = decipher.finish(); // check &#x27;result&#x27; for true/false</span><br><span class="line">            console.log(&quot;result = &quot; + result);</span><br><span class="line">            // outputs decrypted hex</span><br><span class="line">            // console.log(&quot;outputs decrypted hex = &quot; + decipher.output.toHex());</span><br><span class="line"></span><br><span class="line">            var emptySig = decipher.output.getBytes();</span><br><span class="line"></span><br><span class="line">            /* debug for signing</span><br><span class="line">            var md = forge.md.sha256.create();</span><br><span class="line">            var sh = md.update(decipher.output.getBytes()).digest().toHex();</span><br><span class="line">            console.log(&quot;origEmptySig sha256 hash = &quot; + sh);</span><br><span class="line">            var sh = privateKey.sign(md.update(decipher.output.getBytes()))</span><br><span class="line">            */</span><br><span class="line"></span><br><span class="line">            var p7 = forge.pkcs7.createSignedData();</span><br><span class="line">            p7.content = &quot;Arbitrary data&quot;; // privateKey.sign(md.update(decipher.output.getBytes()));</span><br><span class="line"></span><br><span class="line">            let _cert; // individual&#x27;s e-cert</span><br><span class="line">            if (info.ca.indexOf(&#x27;HKPOST&#x27;) != -1) &#123;</span><br><span class="line">              _cert = certChain[0];</span><br><span class="line">              certChain.reverse();</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">              _cert = certChain.slice(-1)[0]</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // e-cert order: root cert, intermediate cert, individual cert</span><br><span class="line">            for (var i = 0; i &lt;= certChain.length - 1; i++) &#123;</span><br><span class="line">              p7.addCertificate(certChain[i]);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            p7.addSigner(&#123;</span><br><span class="line">              key: privateKey,</span><br><span class="line">              certificate: _cert,</span><br><span class="line">              digestAlgorithm: forge.pki.oids.sha256,</span><br><span class="line">              authenticatedAttributes: [&#123;</span><br><span class="line">                type: forge.pki.oids.contentType,</span><br><span class="line">                value: forge.pki.oids.data</span><br><span class="line">              &#125;, &#123;</span><br><span class="line">                type: forge.pki.oids.messageDigest,</span><br><span class="line">                value: emptySig // custom digest</span><br><span class="line">              &#125;, &#123;</span><br><span class="line">                type: forge.pki.oids.signingTime,</span><br><span class="line">                value: new Date()</span><br><span class="line">              &#125;]</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            p7.sign(&#123; detached: true &#125;);</span><br><span class="line"></span><br><span class="line">            //var out = forge.asn1.toDer(p7.toAsn1()).getBytes();</span><br><span class="line">            var out = forge.pkcs7.messageToPem(p7)</span><br><span class="line">            // console.log(out);</span><br><span class="line">            //var signedHash = forge.util.encode64(out);</span><br><span class="line">            signedHash = out.replace(&quot;-----BEGIN PKCS7-----&quot;, &quot;&quot;).replace(&quot;-----END PKCS7-----&quot;, &quot;&quot;).split(&quot;\r\n&quot;).join(&quot;&quot;);</span><br><span class="line">            //console.dir(signedHash);</span><br><span class="line"></span><br><span class="line">            data.signed = signedHash;</span><br><span class="line">            // console.dir(data);</span><br><span class="line"></span><br><span class="line">            $.post(signAndSubmitUrl, data, function (result) &#123;</span><br><span class="line">              //alert(&quot;sign result &quot; + result.status);</span><br><span class="line">              if (result.status == &quot;F&quot;) &#123;</span><br><span class="line">                showError(-131);</span><br><span class="line">              &#125; else &#123;</span><br><span class="line">                showMessage(&quot;doc.sign.success&quot;);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125;).fail(function(xhr, statusText, error)&#123;</span><br><span class="line">              //alert(&quot;error status code &quot; + xhr.status);</span><br><span class="line">              if (xhr.status == 406) &#123;</span><br><span class="line">                  showError(-134);</span><br><span class="line">              &#125; else if (xhr.status == 404) &#123;</span><br><span class="line">                 showError(-133);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          showError(-138);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;).catch(function (info) &#123;</span><br><span class="line">      console.log(&quot;error code : &quot; + info.errCode);</span><br><span class="line">      showError(info.errCode);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  reader.readAsArrayBuffer(file);</span><br><span class="line">  return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="following-code-writtern-was-studied-by-the-result-from-openssl-asn1parse-inform-pem-in-pkcs7-hash-pem"><a href="#following-code-writtern-was-studied-by-the-result-from-openssl-asn1parse-inform-pem-in-pkcs7-hash-pem" class="headerlink" title="following code writtern was studied by the result from openssl asn1parse -inform pem -in pkcs7-hash.pem"></a>following code writtern was studied by the result from <strong>openssl asn1parse -inform pem -in pkcs7-hash.pem</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">for (var i = 0; i &lt;= certChain.length - 1; i++) &#123;</span><br><span class="line">  p7.addCertificate(certChain[i]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">p7.addSigner(&#123;</span><br><span class="line">  key: privateKey,</span><br><span class="line">  certificate: _cert,</span><br><span class="line">  digestAlgorithm: forge.pki.oids.sha256,</span><br><span class="line">  authenticatedAttributes: [&#123;</span><br><span class="line">    type: forge.pki.oids.contentType,</span><br><span class="line">    value: forge.pki.oids.data</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    type: forge.pki.oids.messageDigest,</span><br><span class="line">    value: emptySig // custom digest</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    type: forge.pki.oids.signingTime,</span><br><span class="line">    value: new Date()</span><br><span class="line">  &#125;]</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p7.sign(&#123; detached: true &#125;);</span><br></pre></td></tr></table></figure>

<h2 id="forge-js-was-hacked-by-adding-following-code"><a href="#forge-js-was-hacked-by-adding-following-code" class="headerlink" title="forge.js was hacked by adding following code"></a>forge.js was hacked by adding following code</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">for(var ai = 0; ai &lt; signer.authenticatedAttributes.length; ++ai) &#123;</span><br><span class="line">  var attr = signer.authenticatedAttributes[ai];</span><br><span class="line">  if(attr.type === forge.pki.oids.messageDigest) &#123;</span><br><span class="line">    // use content message digest as value</span><br><span class="line">    // attr.value = mds[signer.digestAlgorithm].digest();</span><br><span class="line"></span><br><span class="line">    // ++++++++ change for setting a custom digest for PDF signing</span><br><span class="line">    var digest = mds[signer.digestAlgorithm].start().update(attr.value).digest();</span><br><span class="line">    attr.value = digest;</span><br><span class="line">    // ++++++++ </span><br><span class="line"></span><br><span class="line">  &#125; else if(attr.type === forge.pki.oids.signingTime) &#123;</span><br><span class="line">    // auto-populate signing time if not already set</span><br><span class="line">    if(!attr.value) &#123;</span><br><span class="line">      attr.value = signingTime;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="AuthenticationApplet-java-itext-for-PDF-signing-below-code-is-as-the-reference-for-study-on-PDF-signing-with-js"><a href="#AuthenticationApplet-java-itext-for-PDF-signing-below-code-is-as-the-reference-for-study-on-PDF-signing-with-js" class="headerlink" title="AuthenticationApplet.java (itext for PDF signing), below code is as the reference for study on PDF signing with js"></a>AuthenticationApplet.java (itext for PDF signing), below code is as the reference for study on PDF signing with js</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">public String signDoc(String emptySig, String keyID, String type, String privateKeyPassword) &#123;</span><br><span class="line">    if (privateKeyPassword == null || &quot;&quot;.equals(privateKeyPassword.trim())) &#123;</span><br><span class="line">        privateKeyPassword = m_password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (&quot;p12&quot;.equals(type)) &#123;</span><br><span class="line">        m_providerName = &quot;BC&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    PrivateKey privateKey = null;</span><br><span class="line">    try &#123;</span><br><span class="line">        privateKey = (PrivateKey) m_keyStore.getKey(keyID, privateKeyPassword.toCharArray());</span><br><span class="line">    &#125; catch (UnrecoverableKeyException | KeyStoreException | NoSuchAlgorithmException e1) &#123;</span><br><span class="line">        e1.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String signHashStr = &quot;&quot;;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        //byte[] origEmptySig = Base64.getUrlDecoder().decode(emptySig);</span><br><span class="line">        byte[] origEmptySig = decrypt(Base64.getDecoder().decode(emptySig), privateKey);</span><br><span class="line">        // System.out.println(&quot;Showing information for debugging PDF signing using javascript</span><br><span class="line">        // System.out.println(&quot;origEmptySig = &quot; + Hex.toHexString(origEmptySig).substring(0, 300));</span><br><span class="line"></span><br><span class="line">        ByteArrayInputStream emptySignature = new ByteArrayInputStream(origEmptySig);</span><br><span class="line"></span><br><span class="line">        Security.addProvider(new BouncyCastleProvider());</span><br><span class="line"></span><br><span class="line">        PrivateKeySignature signature = new PrivateKeySignature(privateKey, &quot;SHA256&quot;, m_providerName);</span><br><span class="line">        String hashAlgorithm = signature.getHashAlgorithm();</span><br><span class="line"></span><br><span class="line">        System.out.println(&quot;hashAlgorithm = &quot; + hashAlgorithm);</span><br><span class="line">        BouncyCastleDigest digest = new BouncyCastleDigest();</span><br><span class="line">        Certificate[] certificateChain = retrieveCertificateChain(keyID);</span><br><span class="line"></span><br><span class="line">        /*String oid = DigestAlgorithms.getAllowedDigests(hashAlgorithm);</span><br><span class="line">        System.out.println(&quot;oid = &quot; + oid);*/</span><br><span class="line"></span><br><span class="line">        MessageDigest messageDigest = digest.getMessageDigest(hashAlgorithm);</span><br><span class="line">        byte hash[] = DigestAlgorithms.digest(emptySignature, messageDigest);</span><br><span class="line"></span><br><span class="line">        //MessageDigest messageDigest = MessageDigest.getInstance(&quot;SHA-256&quot;);</span><br><span class="line">        //byte hash[] = messageDigest.digest(origEmptySig);</span><br><span class="line"></span><br><span class="line">        // System.out.println(&quot;origEmptySig sha256 hash = &quot; + Hex.toHexString(hash));</span><br><span class="line"></span><br><span class="line">        PdfPKCS7 sgn = new PdfPKCS7(null, certificateChain, hashAlgorithm, null, digest, false);</span><br><span class="line">        Calendar cal = Calendar.getInstance();</span><br><span class="line">        byte[] sh = sgn.getAuthenticatedAttributeBytes(hash, cal, null, null, CryptoStandard.CMS);</span><br><span class="line">        //System.out.println(&quot;AuthenticatedAttributeBytes sha256 hash = &quot; + Hex.toHexString(sh));</span><br><span class="line"></span><br><span class="line">        byte[] extSignature = signature.sign(sh);</span><br><span class="line">        //System.out.println(&quot;signed AuthenticatedAttributeBytes = &quot; + Hex.toHexString(hash));</span><br><span class="line"></span><br><span class="line">        sgn.setExternalDigest(extSignature, null, signature.getEncryptionAlgorithm());</span><br><span class="line">        byte[] signHash = sgn.getEncodedPKCS7(hash, cal, null, null, null, CryptoStandard.CMS);</span><br><span class="line"></span><br><span class="line">        // System.out.println(&quot;signHash = &quot; + Hex.toHexString(signHash).substring(0, 300));</span><br><span class="line"></span><br><span class="line">        signHashStr = Base64.getEncoder().encodeToString(signHash);</span><br><span class="line">        //Files.write(Paths.get(&quot;D:/pkcs7-hash.p7b&quot;), signHash, StandardOpenOption.CREATE);</span><br><span class="line"></span><br><span class="line">        //System.out.println(&quot;signHash = &quot; + signHashStr);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        System.err.println(&quot;An unknown error on calculating hash for signature: &quot; + e.getMessage());</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return signHashStr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private static final String RSA_ALGORITHM = &quot;RSA/ECB/PKCS1Padding&quot;;</span><br><span class="line">private static final String AES_ALGORITHM = &quot;AES/ECB/PKCS5Padding&quot;;</span><br><span class="line"></span><br><span class="line">private byte[] decrypt(byte[] ciphertext, PrivateKey privateKey) throws IOException &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        Cipher rsaCipher = Cipher.getInstance(RSA_ALGORITHM);</span><br><span class="line">        rsaCipher.init(Cipher.DECRYPT_MODE, privateKey);</span><br><span class="line"></span><br><span class="line">        DataInputStream dis = new DataInputStream(new ByteArrayInputStream(ciphertext));</span><br><span class="line"></span><br><span class="line">        byte[] encryptedKeyBytes = new byte[dis.readInt()];</span><br><span class="line"></span><br><span class="line">        dis.readFully(encryptedKeyBytes);</span><br><span class="line"></span><br><span class="line">        byte[] aesKeyBytes = rsaCipher.doFinal(encryptedKeyBytes);</span><br><span class="line"></span><br><span class="line">        SecretKeySpec key = new SecretKeySpec(aesKeyBytes, &quot;AES&quot;);</span><br><span class="line">        Cipher cipher = Cipher.getInstance(AES_ALGORITHM);</span><br><span class="line">        cipher.init(Cipher.DECRYPT_MODE, key);</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream output = new ByteArrayOutputStream();</span><br><span class="line">        int len = -1;</span><br><span class="line">        byte[] buffer = new byte[4096];</span><br><span class="line"></span><br><span class="line">        while ((len = dis.read(buffer, 0, buffer.length)) != -1) &#123;</span><br><span class="line">            output.write(buffer, 0, len);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        output.flush();</span><br><span class="line"></span><br><span class="line">        return cipher.doFinal(output.toByteArray());</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        System.err.println(&quot;An unknown error on decrypt key: &quot; + e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a target="_blank" rel="noopener" href="https://security.stackexchange.com/questions/73156/whats-the-difference-between-x-509-and-pkcs7-certificate">https://security.stackexchange.com/questions/73156/whats-the-difference-between-x-509-and-pkcs7-certificate</a><br><a target="_blank" rel="noopener" href="https://security.stackexchange.com/questions/41399/openssl-pkcs7-vs-s-mime">https://security.stackexchange.com/questions/41399/openssl-pkcs7-vs-s-mime</a><br><a target="_blank" rel="noopener" href="https://crypto.stackexchange.com/questions/37084/is-pkcs7-a-signature-format-or-a-certificate-format">https://crypto.stackexchange.com/questions/37084/is-pkcs7-a-signature-format-or-a-certificate-format</a></p>
<p>openssl asn1parse -inform pem -in pkcs7-hash.pem<br><a target="_blank" rel="noopener" href="http://qistoph.blogspot.com/2012/01/manual-verify-pkcs7-signed-data-with.html">Manual verify PKCS#7 signed data with OpenSSL</a></p>

      
    </div>
    <footer>
      
        
        
  
  <div class="tags">
    <a href="/tags/%E5%B7%A5%E4%BD%9C%E6%97%A5%E5%BF%97/">工作日志</a>
  </div>

        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Search">
    <input type="hidden" name="as_sitesearch" value="l1z2g9.github.io">
  </form>
</div>


  

  
<div class="widget tag">
  <h3 class="title">Tags</h3>
  <ul class="entry">
  
    <li><a href="/tags/AIX/">AIX</a><small>29</small></li>
  
    <li><a href="/tags/MySQL/">MySQL</a><small>2</small></li>
  
    <li><a href="/tags/Oracle/">Oracle</a><small>14</small></li>
  
    <li><a href="/tags/Problem-Solve/">Problem Solve</a><small>8</small></li>
  
    <li><a href="/tags/Raspberry-Pi/">Raspberry Pi</a><small>12</small></li>
  
    <li><a href="/tags/%E5%B7%A5%E4%BD%9C%E6%97%A5%E5%BF%97/">工作日志</a><small>68</small></li>
  
    <li><a href="/tags/%E6%97%A5%E5%B8%B8%E8%AE%B0%E5%BD%95/">日常记录</a><small>23</small></li>
  
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2022 Forrest Wan
  
</div>
<div class="clearfix"></div></footer>
  
<script src="/js/jquery-3.4.1.min.js"></script>


<script src="/js/jquery.imagesloaded.min.js"></script>


<script src="/js/gallery.js"></script>





</body>
</html>

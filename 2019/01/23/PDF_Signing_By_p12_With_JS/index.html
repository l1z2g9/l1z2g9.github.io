<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="utf-8">
  
  <title>PDF Signing By p12 With JS | My Blog</title>
  <meta name="author" content="Forrest Wan">
  
  <meta name="description" content="My Blog">
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="PDF Signing By p12 With JS"/>
  <meta property="og:site_name" content="My Blog"/>

  
    <meta property="og:image" content=""/>
  

  <link rel="shortcut icon" href="/favicon.png">
  
  
<link rel="stylesheet" href="/css/style.css">

  <!--[if lt IE 9]><script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script><![endif]-->
  

<meta name="generator" content="Hexo 6.1.0"></head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">My Blog</a></h1>
  <h2><a href="/"></a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/null">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article id="post-PDF_Signing_By_p12_With_JS" class="h-entry post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time class="dt-published" datetime="2019-01-23T08:20:53.000Z"><a href="/2019/01/23/PDF_Signing_By_p12_With_JS/">2019-01-23</a></time>
      
      
  
    <h1 class="p-name title" itemprop="headline name">PDF Signing By p12 With JS</h1>
  

    </header>
    <div class="e-content entry" itemprop="articleBody">
      
        <h2 id="DocSignController-java"><a href="#DocSignController-java" class="headerlink" title="DocSignController.java"></a>DocSignController.java</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/doc-sign/sign&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ResponseEntity&lt;Resource&gt; <span class="title function_">getHashForSign</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    log.debug(<span class="string">&quot;start to generate merged PDF in java web start program&quot;</span>);</span><br><span class="line">    <span class="keyword">synchronized</span> (eventPublisher) &#123;</span><br><span class="line">        eventPublisher.publishEvent(<span class="keyword">new</span> <span class="title class_">OnDocMergeEvent</span>(getUserId(), getXxxFormMaster().getXxxFormMasterId(), getXxxFormMaster().getFormType()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">xxxFormMasterId</span> <span class="operator">=</span> getXxxFormMaster().getXxxFormMasterId();</span><br><span class="line">    <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> getUserId();</span><br><span class="line"></span><br><span class="line">    List&lt;SuppDoc&gt; suppDocs = suppDocMapper.selectSuppDocByXxxFormMasterIdAndDocTypeAndUserId(xxxFormMasterId, userId, Constants.SUPP_DOC_TYPE_SYS_GEN_MERGE);</span><br><span class="line">    <span class="keyword">if</span> (suppDocs == <span class="literal">null</span> || suppDocs.isEmpty()) &#123;</span><br><span class="line">        suppDocs = suppDocMapper.selectSuppDocByXxxFormMasterIdAndDocTypeAndUserId(xxxFormMasterId, userId, Constants.SUPP_DOC_TYPE_SYS_SIGN);</span><br><span class="line">        <span class="keyword">if</span> (suppDocs != <span class="literal">null</span> &amp;&amp; !suppDocs.isEmpty()) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;signed doc exists !!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.status(HttpStatus.NOT_ACCEPTABLE).body(<span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.status(HttpStatus.NOT_FOUND).body(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">SuppDoc</span> <span class="variable">suppDoc</span> <span class="operator">=</span> suppDocs.get(<span class="number">0</span>);</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">suppDocId</span> <span class="operator">=</span> suppDoc.getSuppDocId();</span><br><span class="line"></span><br><span class="line">    <span class="type">Resource</span> <span class="variable">pdfFile</span> <span class="operator">=</span> storageService.loadAsResource(xxxFormMasterId, suppDocId);</span><br><span class="line"></span><br><span class="line">    <span class="type">File</span> <span class="variable">tempPdfFile</span> <span class="operator">=</span> File.createTempFile(<span class="string">&quot;tmp&quot;</span>, <span class="string">&quot;.pdf&quot;</span>);</span><br><span class="line">    log.debug(<span class="string">&quot;Prepare pdf file for sign: &#123;&#125;&quot;</span>, tempPdfFile.getPath());</span><br><span class="line"></span><br><span class="line">    log.info(<span class="string">&quot;get hash for sign, userId &#123;&#125; form master id &#123;&#125;&quot;</span>, userId, xxxFormMasterId);</span><br><span class="line"></span><br><span class="line">    <span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        is = emptySignature(pdfFile.getInputStream(), tempPdfFile);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (DocumentException | GeneralSecurityException e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;error occurrs on calculate signature&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">byte</span>[] encryptedEmptySig = encrypt(StreamUtils.copyToByteArray(is));</span><br><span class="line">    <span class="comment">//byte[] emptySig = StreamUtils.copyToByteArray(is);</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">emptySig</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(encryptedEmptySig);</span><br><span class="line"></span><br><span class="line">    <span class="type">ByteArrayResource</span> <span class="variable">resource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayResource</span>(emptySig.getBytes(StandardCharsets.ISO_8859_1));</span><br><span class="line"></span><br><span class="line">    <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">    headers.add(<span class="string">&quot;Cache-Control&quot;</span>, <span class="string">&quot;no-cache, no-store, must-revalidate&quot;</span>);</span><br><span class="line">    headers.add(<span class="string">&quot;Pragma&quot;</span>, <span class="string">&quot;no-cache&quot;</span>);</span><br><span class="line">    headers.add(<span class="string">&quot;Expires&quot;</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line"></span><br><span class="line">    request.getSession(<span class="literal">false</span>).setAttribute(TEMP_SIGN_PATH, tempPdfFile.getPath());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ResponseEntity.ok()</span><br><span class="line">            .headers(headers)</span><br><span class="line">            .contentLength(resource.contentLength())</span><br><span class="line">            .contentType(MediaType.TEXT_PLAIN)</span><br><span class="line">            .body(resource);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">byte</span>[] encrypt(<span class="type">byte</span>[] emptySig) &#123;</span><br><span class="line">    <span class="comment">/*try &#123;</span></span><br><span class="line"><span class="comment">        log.debug(&quot;js debugging for signing with forge&quot;)</span></span><br><span class="line"><span class="comment">        log.debug(&quot;HexBin.encode(emptySig) &quot; + HexBin.encode(emptySig).substring(0, 500));</span></span><br><span class="line"><span class="comment">        MessageDigest messageDigest = MessageDigest.getInstance(&quot;SHA-256&quot;);</span></span><br><span class="line"><span class="comment">        byte hash[] = messageDigest.digest(emptySig);</span></span><br><span class="line"><span class="comment">        System.out.println(&quot;server emptySig sha256 hash = &quot; + Hex.toHexString(hash));</span></span><br><span class="line"><span class="comment">    &#125; catch (NoSuchAlgorithmException e1) &#123;</span></span><br><span class="line"><span class="comment">    &#125;*/</span></span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">type</span> <span class="operator">=</span> <span class="string">&quot;X.509&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">encodedCertificate</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;certificate&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">CertificateFactory</span> <span class="variable">certificateFactory</span> <span class="operator">=</span> CertificateFactory.getInstance(type);</span><br><span class="line">        <span class="type">Certificate</span> <span class="variable">certificate</span> <span class="operator">=</span> certificateFactory.generateCertificate(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(HashUtils.base64Decode(encodedCertificate)));</span><br><span class="line">        <span class="type">PublicKey</span> <span class="variable">publicKey</span> <span class="operator">=</span> certificate.getPublicKey();</span><br><span class="line"></span><br><span class="line">        Cipher rsaCipher;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            rsaCipher = Cipher.getInstance(RSA_ALGORITHM);</span><br><span class="line">            rsaCipher.init(Cipher.ENCRYPT_MODE, publicKey);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// reference from https://stackoverflow.com/questions/24338108/java-encrypt-string-with-existing-public-key-file</span></span><br><span class="line">            <span class="comment">// Now create a new 256 bit Rijndael key to encrypt the file itself.</span></span><br><span class="line">            <span class="comment">// This will be the session key.</span></span><br><span class="line">            <span class="comment">/*KeyGenerator rijndaelKeyGenerator = KeyGenerator.getInstance(&quot;Rijndael&quot;);</span></span><br><span class="line"><span class="comment">            rijndaelKeyGenerator.init(256);</span></span><br><span class="line"><span class="comment">            log.debug(&quot;Generating session key...&quot;);</span></span><br><span class="line"><span class="comment">            Key rijndaelKey = rijndaelKeyGenerator.generateKey();</span></span><br><span class="line"><span class="comment">            log.debug(&quot;Done generating key.&quot;);</span></span><br><span class="line"><span class="comment">            </span></span><br><span class="line"><span class="comment">            byte[] encodedKeyBytes = rsaCipher.doFinal(rijndaelKey.getEncoded());</span></span><br><span class="line"><span class="comment">            ByteArrayOutputStream output = new ByteArrayOutputStream();</span></span><br><span class="line"><span class="comment">            output.write(encodedKeyBytes.length);</span></span><br><span class="line"><span class="comment">            output.write(encodedKeyBytes);</span></span><br><span class="line"><span class="comment">            </span></span><br><span class="line"><span class="comment">            // Now we need an Initialization Vector for the symmetric cipher in CBC mode</span></span><br><span class="line"><span class="comment">            SecureRandom random = new SecureRandom();</span></span><br><span class="line"><span class="comment">            byte[] iv = new byte[16];</span></span><br><span class="line"><span class="comment">            random.nextBytes(iv);</span></span><br><span class="line"><span class="comment">            </span></span><br><span class="line"><span class="comment">            output.write(iv);</span></span><br><span class="line"><span class="comment">            </span></span><br><span class="line"><span class="comment">            IvParameterSpec spec = new IvParameterSpec(iv);</span></span><br><span class="line"><span class="comment">            // Create the cipher for encrypting the file itself.</span></span><br><span class="line"><span class="comment">            Cipher symmetricCipher = Cipher.getInstance(RIJNDAEL_ALGORITHM);</span></span><br><span class="line"><span class="comment">            symmetricCipher.init(Cipher.ENCRYPT_MODE, rijndaelKey, spec);</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line"></span><br><span class="line">            <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">            <span class="type">DataOutputStream</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataOutputStream</span>(baos);</span><br><span class="line"></span><br><span class="line">            <span class="type">KeyGenerator</span> <span class="variable">generator</span> <span class="operator">=</span> KeyGenerator.getInstance(<span class="string">&quot;AES&quot;</span>);</span><br><span class="line">            generator.init(<span class="number">128</span>);</span><br><span class="line">            log.debug(<span class="string">&quot;Generating session key...&quot;</span>);</span><br><span class="line">            <span class="type">SecretKey</span> <span class="variable">aesKey</span> <span class="operator">=</span> generator.generateKey();</span><br><span class="line">            log.debug(<span class="string">&quot;Done generating key.&quot;</span>);</span><br><span class="line"></span><br><span class="line">            log.debug(<span class="string">&quot;aesKey.getEncoded() = &quot;</span> + Base64.getEncoder().encodeToString(aesKey.getEncoded()));</span><br><span class="line">            <span class="type">byte</span>[] encodedKeyBytes = rsaCipher.doFinal(aesKey.getEncoded());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// output = encrypted AES key length + encrypted AES key + empty signature encrypted by AES key</span></span><br><span class="line">            log.debug(<span class="string">&quot;encrypted AES key length = &quot;</span> + encodedKeyBytes.length);</span><br><span class="line">            output.writeInt(encodedKeyBytes.length);</span><br><span class="line">            output.write(encodedKeyBytes);</span><br><span class="line"></span><br><span class="line">            <span class="type">Cipher</span> <span class="variable">symmetricCipher</span> <span class="operator">=</span> Cipher.getInstance(AES_ALGORITHM);</span><br><span class="line">            symmetricCipher.init(Cipher.ENCRYPT_MODE, aesKey);</span><br><span class="line"></span><br><span class="line">            output.write(symmetricCipher.doFinal(emptySig));</span><br><span class="line">            output.flush();</span><br><span class="line"></span><br><span class="line">            log.debug(<span class="string">&quot;length of encrypted data = &quot;</span> + baos.toByteArray().length);</span><br><span class="line">            <span class="keyword">return</span> baos.toByteArray();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException | NoSuchPaddingException | InvalidKeyException</span><br><span class="line">                | IllegalBlockSizeException | BadPaddingException | IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;encrypt empty signature&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (CertificateException e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;encrypt&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> InputStream <span class="title function_">emptySignature</span><span class="params">(InputStream src, File dest)</span></span><br><span class="line">        <span class="keyword">throws</span> IOException, DocumentException, GeneralSecurityException &#123;</span><br><span class="line">    <span class="type">PdfReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PdfReader</span>(src);</span><br><span class="line">    <span class="type">FileOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(dest);</span><br><span class="line">    <span class="type">PdfStamper</span> <span class="variable">stamper</span> <span class="operator">=</span> PdfStamper.createSignature(reader, os, <span class="string">&#x27;\0&#x27;</span>);</span><br><span class="line">    <span class="type">PdfSignatureAppearance</span> <span class="variable">appearance</span> <span class="operator">=</span> stamper.getSignatureAppearance();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//appearance.setVisibleSignature(new Rectangle(0, 0, 0, 0), 1, FIELD_NAME);</span></span><br><span class="line">    log.info(<span class="string">&quot;create empty signature&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">position</span> <span class="operator">=</span> (String) WebUtils.getSession().getAttribute(WebAttributeNames.SESSION_PSCT_DOC_SIGNATURE_POSITION);</span><br><span class="line">    String[] p = position.split(<span class="string">&quot;\\|&quot;</span>);</span><br><span class="line">    appearance.setVisibleSignature(<span class="keyword">new</span> <span class="title class_">Rectangle</span>(Float.valueOf(p[<span class="number">0</span>]), Float.valueOf(p[<span class="number">1</span>]), Float.valueOf(p[<span class="number">2</span>]), Float.valueOf(p[<span class="number">3</span>])), Integer.valueOf(p[<span class="number">4</span>]), Constants.SIG_FIELD_NAME);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set signature text</span></span><br><span class="line">    <span class="type">Font</span> <span class="variable">font</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Font</span>(FontFamily.TIMES_ROMAN, <span class="number">10</span>, Font.BOLD);</span><br><span class="line">    appearance.setLayer2Font(font);</span><br><span class="line">    appearance.setRunDirection(PdfWriter.RUN_DIRECTION_RTL);</span><br><span class="line"></span><br><span class="line">    appearance.setLayer2Text(<span class="string">&quot;Signed By Digital Certificate&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">ClassPathResource</span> <span class="variable">pinImage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;static/images/Cert-sign.png&quot;</span>);</span><br><span class="line">    appearance.setImage(Image.getInstance(pinImage.getURL()));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//appearance.setCertificate(chain[0]);</span></span><br><span class="line">    <span class="type">ExternalSignatureContainer</span> <span class="variable">external</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExternalBlankSignatureContainer</span>(PdfName.ADOBE_PPKLITE,</span><br><span class="line">            PdfName.ADBE_PKCS7_DETACHED);</span><br><span class="line">    MakeSignature.signExternalContainer(appearance, external, <span class="number">8192</span>);</span><br><span class="line">    os.close();</span><br><span class="line">    <span class="keyword">return</span> appearance.getRangeStream();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@PostMapping(value = &quot;/doc-sign/sign&quot;, produces = MediaType.APPLICATION_JSON_VALUE)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> CertSignResult <span class="title function_">attachSignedHash</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">CertSignResult</span> <span class="variable">certSignResult</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CertSignResult</span>();</span><br><span class="line">    certSignResult.setStatus(CertSignResult.STATUS_NOT_SIGNED);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!WebUtils.validateCert(pkiClient)) &#123;</span><br><span class="line">            <span class="keyword">return</span> certSignResult;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;signHash&quot;</span>, e);</span><br><span class="line">        <span class="keyword">return</span> certSignResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">tempPath</span> <span class="operator">=</span> (String) request.getSession(<span class="literal">false</span>).getAttribute(TEMP_SIGN_PATH);</span><br><span class="line"></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">xxxFormMasterId</span> <span class="operator">=</span> getXxxFormMaster().getXxxFormMasterId();</span><br><span class="line">    <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> getUserId();</span><br><span class="line"></span><br><span class="line">    log.info(<span class="string">&quot;sign hash, userId &#123;&#125; form master id &#123;&#125;&quot;</span>, userId, xxxFormMasterId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//		tryToDeleteSignedDoc();</span></span><br><span class="line"></span><br><span class="line">    <span class="type">File</span> <span class="variable">tempSignedFile</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        tempSignedFile = File.createTempFile(<span class="string">&quot;signed-&quot;</span> + xxxFormMasterId + <span class="string">&quot;-&quot;</span>, <span class="string">&quot;.pdf&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">hash</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;signed&quot;</span>);</span><br><span class="line">        <span class="comment">//log.debug(&quot;hash &#123;&#125;&quot;, hash);</span></span><br><span class="line">        <span class="comment">// Save the hash to file pkcs7-hash.pem</span></span><br><span class="line">        <span class="comment">// View p7 file content by: openssl asn1parse -inform pem -in pkcs7-hash.pem</span></span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] signedhash = Base64.getDecoder().decode(hash);</span><br><span class="line"></span><br><span class="line">        createSignature(tempPath, tempSignedFile, signedhash);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (DocumentException | GeneralSecurityException | IOException e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;Fail to sign document &quot;</span> + e);</span><br><span class="line">        <span class="keyword">return</span> certSignResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">SimpleSuppDoc</span> <span class="variable">doc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleSuppDoc</span>();</span><br><span class="line">    doc.setXxxFormMasterId(xxxFormMasterId);</span><br><span class="line">    doc.setLocalFile(tempSignedFile);</span><br><span class="line">    doc.setSuppDocType(Constants.SUPP_DOC_TYPE_SYS_SIGN);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">suppDocId</span> <span class="operator">=</span> storageService.store(doc, userId);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (doc.isUploadSucess()) &#123;</span><br><span class="line">            insertSigningLog(userId, xxxFormMasterId, suppDocId);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// no need to keep the merged doc</span></span><br><span class="line">            storageService.deleteDocByUserIdAndType(xxxFormMasterId, userId, Constants.SUPP_DOC_TYPE_SYS_GEN_MERGE);</span><br><span class="line"></span><br><span class="line">            certSignResult.setStatus(CertSignResult.STATUS_SIGNED);</span><br><span class="line">            request.getSession(<span class="literal">false</span>).setAttribute(WebAttributeNames.SESSION_PSCT_DOC_SIGN_STATUS, certSignResult);</span><br><span class="line"></span><br><span class="line">            createZipFileForSignedDoc(userId, tempSignedFile);</span><br><span class="line">            <span class="keyword">return</span> certSignResult;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;sign pdf file&quot;</span>, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (tempSignedFile != <span class="literal">null</span>)</span><br><span class="line">            tempSignedFile.delete();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> certSignResult;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">createSignature</span><span class="params">(String src, File dest, <span class="type">byte</span>[] signedHash)</span></span><br><span class="line">        <span class="keyword">throws</span> IOException, DocumentException, GeneralSecurityException &#123;</span><br><span class="line">    <span class="type">PdfReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PdfReader</span>(src);</span><br><span class="line">    <span class="type">FileOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(dest);</span><br><span class="line">    <span class="type">ExternalSignatureContainer</span> <span class="variable">external</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyExternalSignatureContainer</span>(signedHash);</span><br><span class="line">    MakeSignature.signDeferred(reader, Constants.SIG_FIELD_NAME, os, external);</span><br><span class="line">    os.close();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyExternalSignatureContainer</span> <span class="keyword">implements</span> <span class="title class_">ExternalSignatureContainer</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="type">byte</span>[] sig;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyExternalSignatureContainer</span><span class="params">(<span class="type">byte</span>[] sig)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.sig = sig;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">modifySigningDictionary</span><span class="params">(PdfDictionary signDic)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] sign(InputStream arg0) <span class="keyword">throws</span> GeneralSecurityException &#123;</span><br><span class="line">        <span class="keyword">return</span> sig;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="JS-for-PDF-signing"><a href="#JS-for-PDF-signing" class="headerlink" title="JS for PDF signing"></a>JS for PDF signing</h2><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">signAndSubmit</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&quot;signAndSubmit&quot;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> idType = $(<span class="string">&quot;:radio[name=&#x27;idType&#x27;]:checked&quot;</span>).val();</span><br><span class="line">  <span class="keyword">var</span> hkid = $(<span class="string">&quot;#hkid&quot;</span>).val();</span><br><span class="line">  <span class="keyword">var</span> hkidCheckDigit = $(<span class="string">&quot;#hkidCheckDigit&quot;</span>).val();</span><br><span class="line">  <span class="keyword">var</span> passport = $(<span class="string">&quot;#passport&quot;</span>).val()</span><br><span class="line">  <span class="keyword">var</span> file = document.getElementById(<span class="string">&quot;filename&quot;</span>).files[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!checkInput(idType, hkid, hkidCheckDigit, passport, file))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> password = $(<span class="string">&quot;#pin&quot;</span>).val();</span><br><span class="line">  <span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&quot;password &quot;</span> + password)</span><br><span class="line"></span><br><span class="line">  <span class="comment">//Reading certificate from a &#x27;file&#x27; form field</span></span><br><span class="line">  <span class="keyword">var</span> reader = <span class="keyword">new</span> FileReader();</span><br><span class="line">  reader.onload = <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> contents = e.target.result;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> pkcs12 = loadFile(password, contents);</span><br><span class="line">    <span class="keyword">if</span>(!pkcs12)&#123;</span><br><span class="line">      showError(ErrorCode.INVALID_PIN);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    extractInfo(pkcs12, idType, hkid, hkidCheckDigit, passport).then(<span class="keyword">function</span> (<span class="params">info</span>) &#123;</span><br><span class="line">      <span class="keyword">var</span> data = &#123;</span><br><span class="line">        <span class="attr">signature</span>: info.signature,</span><br><span class="line">        <span class="comment">// certLogin: &quot;1&quot;,</span></span><br><span class="line">        certificate: info.certificate,</span><br><span class="line">        <span class="attr">hkid</span>: hkid + <span class="string">&quot;:&quot;</span> + hkidCheckDigit,</span><br><span class="line">        <span class="attr">passport</span>: passport,</span><br><span class="line">        <span class="attr">idType</span>: idType,</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">        <span class="attr">url</span>: resetStatusUrl + <span class="string">&quot;?keep-challenge=1&quot;</span>,</span><br><span class="line">        <span class="attr">dataType</span>: <span class="string">&#x27;json&#x27;</span>,</span><br><span class="line">        <span class="attr">async</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">success</span>: <span class="keyword">function</span>(<span class="params">result</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (result == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&quot;start to do signing for the PDF&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">error</span>: <span class="keyword">function</span>(<span class="params">exception</span>) &#123;</span><br><span class="line">          window.location.href = errPath;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    $.get(validateUserUrl, &#123; <span class="attr">hkid</span>: data.hkid, <span class="attr">passport</span>: data.passport, <span class="attr">idType</span>: data.idType &#125;).done(<span class="keyword">function</span> (<span class="params">result</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (result == <span class="string">&#x27;T&#x27;</span>) &#123;</span><br><span class="line">          $.get(signAndSubmitUrl, &#123; <span class="attr">certificate</span>: data.certificate &#125;).done(<span class="keyword">function</span> (<span class="params">signature</span>) &#123;</span><br><span class="line">            <span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&quot;signature = &quot;</span> + signature.<span class="built_in">length</span>);</span><br><span class="line">            <span class="keyword">var</span> ciphertext = forge.util.decode64(signature);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> <span class="built_in">buffer</span> = forge.util.createBuffer(ciphertext, <span class="string">&#x27;binary&#x27;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> aesKeyLength = <span class="built_in">buffer</span>.getInt32();</span><br><span class="line">            <span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&quot;aesKeyLength = &quot;</span> + aesKeyLength);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> encryptedAesKey = <span class="built_in">buffer</span>.getBytes(aesKeyLength);</span><br><span class="line">            <span class="built_in">console</span>.dir(encryptedAesKey);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> aesKey = privateKey.decrypt(encryptedAesKey);</span><br><span class="line">            <span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&quot;decrypted aesKey = &quot;</span> + forge.util.encode64(aesKey));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> decipher = forge.cipher.createDecipher(<span class="string">&#x27;AES-ECB&#x27;</span>, aesKey);</span><br><span class="line">            decipher.start();</span><br><span class="line">            decipher.update(forge.util.createBuffer(<span class="built_in">buffer</span>.getBytes()));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> result = decipher.finish(); <span class="comment">// check &#x27;result&#x27; for true/false</span></span><br><span class="line">            <span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&quot;result = &quot;</span> + result);</span><br><span class="line">            <span class="comment">// outputs decrypted hex</span></span><br><span class="line">            <span class="comment">// console.log(&quot;outputs decrypted hex = &quot; + decipher.output.toHex());</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> emptySig = decipher.output.getBytes();</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* debug for signing</span></span><br><span class="line"><span class="comment">            var md = forge.md.sha256.create();</span></span><br><span class="line"><span class="comment">            var sh = md.update(decipher.output.getBytes()).digest().toHex();</span></span><br><span class="line"><span class="comment">            console.log(&quot;origEmptySig sha256 hash = &quot; + sh);</span></span><br><span class="line"><span class="comment">            var sh = privateKey.sign(md.update(decipher.output.getBytes()))</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> p7 = forge.pkcs7.createSignedData();</span><br><span class="line">            p7.content = <span class="string">&quot;Arbitrary data&quot;</span>; <span class="comment">// privateKey.sign(md.update(decipher.output.getBytes()));</span></span><br><span class="line"></span><br><span class="line">            let _cert; <span class="comment">// individual&#x27;s e-cert</span></span><br><span class="line">            <span class="keyword">if</span> (info.ca.<span class="built_in">indexOf</span>(<span class="string">&#x27;HKPOST&#x27;</span>) != <span class="number">-1</span>) &#123;</span><br><span class="line">              _cert = certChain[<span class="number">0</span>];</span><br><span class="line">              certChain.<span class="built_in">reverse</span>();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              _cert = certChain.<span class="built_in">slice</span>(<span class="number">-1</span>)[<span class="number">0</span>]</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// e-cert order: root cert, intermediate cert, individual cert</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt;= certChain.<span class="built_in">length</span> - <span class="number">1</span>; i++) &#123;</span><br><span class="line">              p7.addCertificate(certChain[i]);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            p7.addSigner(&#123;</span><br><span class="line">              <span class="attr">key</span>: privateKey,</span><br><span class="line">              <span class="attr">certificate</span>: _cert,</span><br><span class="line">              <span class="attr">digestAlgorithm</span>: forge.pki.oids.sha256,</span><br><span class="line">              <span class="attr">authenticatedAttributes</span>: [&#123;</span><br><span class="line">                <span class="attr">type</span>: forge.pki.oids.contentType,</span><br><span class="line">                <span class="attr">value</span>: forge.pki.oids.data</span><br><span class="line">              &#125;, &#123;</span><br><span class="line">                <span class="attr">type</span>: forge.pki.oids.messageDigest,</span><br><span class="line">                <span class="attr">value</span>: emptySig <span class="comment">// custom digest</span></span><br><span class="line">              &#125;, &#123;</span><br><span class="line">                <span class="attr">type</span>: forge.pki.oids.signingTime,</span><br><span class="line">                <span class="attr">value</span>: <span class="keyword">new</span> <span class="built_in">Date</span>()</span><br><span class="line">              &#125;]</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            p7.sign(&#123; <span class="attr">detached</span>: <span class="literal">true</span> &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//var out = forge.asn1.toDer(p7.toAsn1()).getBytes();</span></span><br><span class="line">            <span class="keyword">var</span> out = forge.pkcs7.messageToPem(p7)</span><br><span class="line">            <span class="comment">// console.log(out);</span></span><br><span class="line">            <span class="comment">//var signedHash = forge.util.encode64(out);</span></span><br><span class="line">            signedHash = out.<span class="built_in">replace</span>(<span class="string">&quot;-----BEGIN PKCS7-----&quot;</span>, <span class="string">&quot;&quot;</span>).<span class="built_in">replace</span>(<span class="string">&quot;-----END PKCS7-----&quot;</span>, <span class="string">&quot;&quot;</span>).<span class="built_in">split</span>(<span class="string">&quot;\r\n&quot;</span>).join(<span class="string">&quot;&quot;</span>);</span><br><span class="line">            <span class="comment">//console.dir(signedHash);</span></span><br><span class="line"></span><br><span class="line">            data.signed = signedHash;</span><br><span class="line">            <span class="comment">// console.dir(data);</span></span><br><span class="line"></span><br><span class="line">            $.post(signAndSubmitUrl, data, <span class="keyword">function</span> (<span class="params">result</span>) &#123;</span><br><span class="line">              <span class="comment">//alert(&quot;sign result &quot; + result.status);</span></span><br><span class="line">              <span class="keyword">if</span> (result.status == <span class="string">&quot;F&quot;</span>) &#123;</span><br><span class="line">                showError(<span class="number">-131</span>);</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                showMessage(<span class="string">&quot;doc.sign.success&quot;</span>);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125;).fail(<span class="keyword">function</span>(<span class="params">xhr, statusText, error</span>)&#123;</span><br><span class="line">              <span class="comment">//alert(&quot;error status code &quot; + xhr.status);</span></span><br><span class="line">              <span class="keyword">if</span> (xhr.status == <span class="number">406</span>) &#123;</span><br><span class="line">                  showError(<span class="number">-134</span>);</span><br><span class="line">              &#125; <span class="keyword">else</span> <span class="keyword">if</span> (xhr.status == <span class="number">404</span>) &#123;</span><br><span class="line">                 showError(<span class="number">-133</span>);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          showError(<span class="number">-138</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;).catch(<span class="keyword">function</span> (<span class="params">info</span>) &#123;</span><br><span class="line">      <span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&quot;error code : &quot;</span> + info.errCode);</span><br><span class="line">      showError(info.errCode);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  reader.readAsArrayBuffer(file);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="following-code-writtern-was-studied-by-the-result-from-openssl-asn1parse-inform-pem-in-pkcs7-hash-pem"><a href="#following-code-writtern-was-studied-by-the-result-from-openssl-asn1parse-inform-pem-in-pkcs7-hash-pem" class="headerlink" title="following code writtern was studied by the result from openssl asn1parse -inform pem -in pkcs7-hash.pem"></a>following code writtern was studied by the result from <strong>openssl asn1parse -inform pem -in pkcs7-hash.pem</strong></h3><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (var i = <span class="number">0</span>; i &lt;= certChain.length - <span class="number">1</span>; i++) &#123;</span><br><span class="line">  p7.addCertificate(certChain[i]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">p7.addSigner(&#123;</span><br><span class="line">  key: privateKey,</span><br><span class="line">  certificate: _cert,</span><br><span class="line">  digestAlgorithm: forge.pki.<span class="keyword">oids</span>.sha256,</span><br><span class="line">  authenticatedAttributes: [&#123;</span><br><span class="line">    <span class="keyword">type</span>: forge.pki.<span class="keyword">oids</span>.contentType,</span><br><span class="line">    <span class="keyword">value</span>: forge.pki.<span class="keyword">oids</span>.data</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    <span class="keyword">type</span>: forge.pki.<span class="keyword">oids</span>.messageDigest,</span><br><span class="line">    <span class="keyword">value</span>: emptySig // custom digest</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    <span class="keyword">type</span>: forge.pki.<span class="keyword">oids</span>.signingTime,</span><br><span class="line">    <span class="keyword">value</span>: <span class="built_in">new</span> <span class="type">Date</span>()</span><br><span class="line">  &#125;]</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p7.sign(&#123; detached: <span class="keyword">true</span> &#125;);</span><br></pre></td></tr></table></figure>

<h2 id="forge-js-was-hacked-by-adding-following-code"><a href="#forge-js-was-hacked-by-adding-following-code" class="headerlink" title="forge.js was hacked by adding following code"></a>forge.js was hacked by adding following code</h2><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(var ai = <span class="number">0</span>; ai &lt; signer.authenticatedAttributes.length; ++ai) &#123;</span><br><span class="line">  var attr = signer.authenticatedAttributes[ai];</span><br><span class="line">  <span class="keyword">if</span>(attr.<span class="keyword">type</span> === forge.pki.<span class="keyword">oids</span>.messageDigest) &#123;</span><br><span class="line">    // use content message digest <span class="keyword">as</span> <span class="keyword">value</span></span><br><span class="line">    // attr.<span class="keyword">value</span> = mds[signer.digestAlgorithm].digest();</span><br><span class="line"></span><br><span class="line">    // ++++++++ change <span class="keyword">for</span> setting a custom digest <span class="keyword">for</span> PDF signing</span><br><span class="line">    var digest = mds[signer.digestAlgorithm].<span class="keyword">start</span>().<span class="keyword">update</span>(attr.<span class="keyword">value</span>).digest();</span><br><span class="line">    attr.<span class="keyword">value</span> = digest;</span><br><span class="line">    // ++++++++ </span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>(attr.<span class="keyword">type</span> === forge.pki.<span class="keyword">oids</span>.signingTime) &#123;</span><br><span class="line">    // auto-populate signing <span class="type">time</span> <span class="keyword">if</span> <span class="keyword">not</span> already <span class="keyword">set</span></span><br><span class="line">    <span class="keyword">if</span>(!attr.<span class="keyword">value</span>) &#123;</span><br><span class="line">      attr.<span class="keyword">value</span> = signingTime;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="AuthenticationApplet-java-itext-for-PDF-signing-below-code-is-as-the-reference-for-study-on-PDF-signing-with-js"><a href="#AuthenticationApplet-java-itext-for-PDF-signing-below-code-is-as-the-reference-for-study-on-PDF-signing-with-js" class="headerlink" title="AuthenticationApplet.java (itext for PDF signing), below code is as the reference for study on PDF signing with js"></a>AuthenticationApplet.java (itext for PDF signing), below code is as the reference for study on PDF signing with js</h2><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">public String sign<span class="constructor">Doc(String <span class="params">emptySig</span>, String <span class="params">keyID</span>, String <span class="params">type</span>, String <span class="params">privateKeyPassword</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (privateKeyPassword<span class="operator"> == </span>null<span class="operator"> || </span><span class="string">&quot;&quot;</span>.equals(privateKeyPassword.trim<span class="literal">()</span>)) &#123;</span><br><span class="line">        privateKeyPassword = m_password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;p12&quot;</span>.equals(<span class="keyword">type</span>)) &#123;</span><br><span class="line">        m_providerName = <span class="string">&quot;BC&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    PrivateKey privateKey = null;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        privateKey = (PrivateKey) m_keyStore.get<span class="constructor">Key(<span class="params">keyID</span>, <span class="params">privateKeyPassword</span>.<span class="params">toCharArray</span>()</span>);</span><br><span class="line">    &#125; catch (UnrecoverableKeyException <span class="pattern-match">| <span class="constructor">KeyStoreException</span> | <span class="constructor">NoSuchAlgorithmException</span> e1) &#123;</span></span><br><span class="line"><span class="pattern-match">        e1.print<span class="constructor">StackTrace()</span>;</span></span><br><span class="line"><span class="pattern-match">    &#125;</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">    <span class="constructor">String</span> sign<span class="constructor">HashStr</span> = &quot;&quot;;</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">    <span class="keyword">try</span> &#123;</span></span><br><span class="line"><span class="pattern-match">        <span class="operator">/</span><span class="operator">/</span>byte[] orig<span class="constructor">EmptySig</span> = <span class="constructor">Base64</span>.get<span class="constructor">UrlDecoder()</span>.decode(empty<span class="constructor">Sig</span>);</span></span><br><span class="line"><span class="pattern-match">        byte[] orig<span class="constructor">EmptySig</span> = decrypt(<span class="constructor">Base64</span>.get<span class="constructor">Decoder()</span>.decode(empty<span class="constructor">Sig</span>), <span class="keyword">private</span><span class="constructor">Key</span>);</span></span><br><span class="line"><span class="pattern-match">        <span class="operator">/</span><span class="operator">/</span> <span class="constructor">System</span>.out.println(&quot;<span class="constructor">Showing</span> information <span class="keyword">for</span> debugging <span class="constructor">PDF</span> signing using javascript</span></span><br><span class="line"><span class="pattern-match">        <span class="operator">/</span><span class="operator">/</span> <span class="constructor">System</span>.out.println(&quot;orig<span class="constructor">EmptySig</span> = &quot; + <span class="constructor">Hex</span>.<span class="keyword">to</span><span class="constructor">HexString(<span class="params">origEmptySig</span>)</span>.substring(0, 300));</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">        <span class="constructor">ByteArrayInputStream</span> empty<span class="constructor">Signature</span> = <span class="keyword">new</span> <span class="constructor">ByteArrayInputStream(<span class="params">origEmptySig</span>)</span>;</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">        <span class="constructor">Security</span>.add<span class="constructor">Provider(<span class="params">new</span> BouncyCastleProvider()</span>);</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">        <span class="constructor">PrivateKeySignature</span> signature = <span class="keyword">new</span> <span class="constructor">PrivateKeySignature(<span class="params">privateKey</span>, <span class="string">&quot;SHA256&quot;</span>, <span class="params">m_providerName</span>)</span>;</span></span><br><span class="line"><span class="pattern-match">        <span class="constructor">String</span> hash<span class="constructor">Algorithm</span> = signature.get<span class="constructor">HashAlgorithm()</span>;</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">        <span class="constructor">System</span>.out.println(&quot;hash<span class="constructor">Algorithm</span> = &quot; + hash<span class="constructor">Algorithm</span>);</span></span><br><span class="line"><span class="pattern-match">        <span class="constructor">BouncyCastleDigest</span> digest = <span class="keyword">new</span> <span class="constructor">BouncyCastleDigest()</span>;</span></span><br><span class="line"><span class="pattern-match">        <span class="constructor">Certificate</span>[] certificate<span class="constructor">Chain</span> = retrieve<span class="constructor">CertificateChain(<span class="params">keyID</span>)</span>;</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">        <span class="operator">/</span><span class="operator">*</span><span class="constructor">String</span> oid = <span class="constructor">DigestAlgorithms</span>.get<span class="constructor">AllowedDigests(<span class="params">hashAlgorithm</span>)</span>;</span></span><br><span class="line"><span class="pattern-match">        <span class="constructor">System</span>.out.println(&quot;oid = &quot; + oid);<span class="operator">*</span><span class="operator">/</span></span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">        <span class="constructor">MessageDigest</span> message<span class="constructor">Digest</span> = digest.get<span class="constructor">MessageDigest(<span class="params">hashAlgorithm</span>)</span>;</span></span><br><span class="line"><span class="pattern-match">        byte hash[] = <span class="constructor">DigestAlgorithms</span>.digest(empty<span class="constructor">Signature</span>, message<span class="constructor">Digest</span>);</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">        <span class="operator">/</span><span class="operator">/</span><span class="constructor">MessageDigest</span> message<span class="constructor">Digest</span> = <span class="constructor">MessageDigest</span>.get<span class="constructor">Instance(<span class="string">&quot;SHA-256&quot;</span>)</span>;</span></span><br><span class="line"><span class="pattern-match">        <span class="operator">/</span><span class="operator">/</span>byte hash[] = message<span class="constructor">Digest</span>.digest(orig<span class="constructor">EmptySig</span>);</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">        <span class="operator">/</span><span class="operator">/</span> <span class="constructor">System</span>.out.println(&quot;orig<span class="constructor">EmptySig</span> sha256 hash = &quot; + <span class="constructor">Hex</span>.<span class="keyword">to</span><span class="constructor">HexString(<span class="params">hash</span>)</span>);</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">        <span class="constructor">PdfPKCS7</span> sgn = <span class="keyword">new</span> <span class="constructor">PdfPKCS7(<span class="params">null</span>, <span class="params">certificateChain</span>, <span class="params">hashAlgorithm</span>, <span class="params">null</span>, <span class="params">digest</span>, <span class="params">false</span>)</span>;</span></span><br><span class="line"><span class="pattern-match">        <span class="constructor">Calendar</span> cal = <span class="constructor">Calendar</span>.get<span class="constructor">Instance()</span>;</span></span><br><span class="line"><span class="pattern-match">        byte[] sh = sgn.get<span class="constructor">AuthenticatedAttributeBytes(<span class="params">hash</span>, <span class="params">cal</span>, <span class="params">null</span>, <span class="params">null</span>, CryptoStandard.CMS)</span>;</span></span><br><span class="line"><span class="pattern-match">        <span class="operator">/</span><span class="operator">/</span><span class="constructor">System</span>.out.println(&quot;<span class="constructor">AuthenticatedAttributeBytes</span> sha256 hash = &quot; + <span class="constructor">Hex</span>.<span class="keyword">to</span><span class="constructor">HexString(<span class="params">sh</span>)</span>);</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">        byte[] ext<span class="constructor">Signature</span> = signature.sign(sh);</span></span><br><span class="line"><span class="pattern-match">        <span class="operator">/</span><span class="operator">/</span><span class="constructor">System</span>.out.println(&quot;signed <span class="constructor">AuthenticatedAttributeBytes</span> = &quot; + <span class="constructor">Hex</span>.<span class="keyword">to</span><span class="constructor">HexString(<span class="params">hash</span>)</span>);</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">        sgn.set<span class="constructor">ExternalDigest(<span class="params">extSignature</span>, <span class="params">null</span>, <span class="params">signature</span>.<span class="params">getEncryptionAlgorithm</span>()</span>);</span></span><br><span class="line"><span class="pattern-match">        byte[] sign<span class="constructor">Hash</span> = sgn.get<span class="constructor">EncodedPKCS7(<span class="params">hash</span>, <span class="params">cal</span>, <span class="params">null</span>, <span class="params">null</span>, <span class="params">null</span>, CryptoStandard.CMS)</span>;</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">        <span class="operator">/</span><span class="operator">/</span> <span class="constructor">System</span>.out.println(&quot;sign<span class="constructor">Hash</span> = &quot; + <span class="constructor">Hex</span>.<span class="keyword">to</span><span class="constructor">HexString(<span class="params">signHash</span>)</span>.substring(0, 300));</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">        sign<span class="constructor">HashStr</span> = <span class="constructor">Base64</span>.get<span class="constructor">Encoder()</span>.encode<span class="constructor">ToString(<span class="params">signHash</span>)</span>;</span></span><br><span class="line"><span class="pattern-match">        <span class="operator">/</span><span class="operator">/</span><span class="constructor">Files</span>.write(<span class="constructor">Paths</span>.get(&quot;<span class="constructor">D</span>:<span class="operator">/</span>pkcs7-hash.p7b&quot;), sign<span class="constructor">Hash</span>, <span class="constructor">StandardOpenOption</span>.<span class="constructor">CREATE</span>);</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">        <span class="operator">/</span><span class="operator">/</span><span class="constructor">System</span>.out.println(&quot;sign<span class="constructor">Hash</span> = &quot; + sign<span class="constructor">HashStr</span>);</span></span><br><span class="line"><span class="pattern-match">    &#125; catch (<span class="constructor">Exception</span> e) &#123;</span></span><br><span class="line"><span class="pattern-match">        <span class="constructor">System</span>.err.println(&quot;<span class="constructor">An</span> unknown error on calculating hash <span class="keyword">for</span> signature: &quot; + e.get<span class="constructor">Message()</span>);</span></span><br><span class="line"><span class="pattern-match">        e.print<span class="constructor">StackTrace()</span>;</span></span><br><span class="line"><span class="pattern-match">    &#125;</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">    return sign<span class="constructor">HashStr</span>;</span></span><br><span class="line"><span class="pattern-match">&#125;</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match"><span class="keyword">private</span> static final <span class="constructor">String</span> <span class="constructor">RSA_ALGORITHM</span> = &quot;<span class="constructor">RSA</span><span class="operator">/</span><span class="constructor">ECB</span><span class="operator">/</span><span class="constructor">PKCS1Padding</span>&quot;;</span></span><br><span class="line"><span class="pattern-match"><span class="keyword">private</span> static final <span class="constructor">String</span> <span class="constructor">AES_ALGORITHM</span> = &quot;<span class="constructor">AES</span><span class="operator">/</span><span class="constructor">ECB</span><span class="operator">/</span><span class="constructor">PKCS5Padding</span>&quot;;</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match"><span class="keyword">private</span> byte[] decrypt(byte[] ciphertext, <span class="constructor">PrivateKey</span> <span class="keyword">private</span><span class="constructor">Key</span>) throws <span class="constructor">IOException</span> &#123;</span></span><br><span class="line"><span class="pattern-match">    <span class="keyword">try</span> &#123;</span></span><br><span class="line"><span class="pattern-match">        <span class="constructor">Cipher</span> rsa<span class="constructor">Cipher</span> = <span class="constructor">Cipher</span>.get<span class="constructor">Instance(RSA_ALGORITHM)</span>;</span></span><br><span class="line"><span class="pattern-match">        rsa<span class="constructor">Cipher</span>.init(<span class="constructor">Cipher</span>.<span class="constructor">DECRYPT_MODE</span>, <span class="keyword">private</span><span class="constructor">Key</span>);</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">        <span class="constructor">DataInputStream</span> dis = <span class="keyword">new</span> <span class="constructor">DataInputStream(<span class="params">new</span> ByteArrayInputStream(<span class="params">ciphertext</span>)</span>);</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">        byte[] encrypted<span class="constructor">KeyBytes</span> = <span class="keyword">new</span> byte[dis.read<span class="constructor">Int()</span>];</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">        dis.read<span class="constructor">Fully(<span class="params">encryptedKeyBytes</span>)</span>;</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">        byte[] aes<span class="constructor">KeyBytes</span> = rsa<span class="constructor">Cipher</span>.<span class="keyword">do</span><span class="constructor">Final(<span class="params">encryptedKeyBytes</span>)</span>;</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">        <span class="constructor">SecretKeySpec</span> key = <span class="keyword">new</span> <span class="constructor">SecretKeySpec(<span class="params">aesKeyBytes</span>, <span class="string">&quot;AES&quot;</span>)</span>;</span></span><br><span class="line"><span class="pattern-match">        <span class="constructor">Cipher</span> cipher = <span class="constructor">Cipher</span>.get<span class="constructor">Instance(AES_ALGORITHM)</span>;</span></span><br><span class="line"><span class="pattern-match">        cipher.init(<span class="constructor">Cipher</span>.<span class="constructor">DECRYPT_MODE</span>, key);</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">        <span class="constructor">ByteArrayOutputStream</span> output = <span class="keyword">new</span> <span class="constructor">ByteArrayOutputStream()</span>;</span></span><br><span class="line"><span class="pattern-match">        <span class="built_in">int</span> len = -1;</span></span><br><span class="line"><span class="pattern-match">        byte[] buffer = <span class="keyword">new</span> byte[4096];</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">        <span class="keyword">while</span> ((len = dis.read(buffer, 0, buffer.length)) != -1) &#123;</span></span><br><span class="line"><span class="pattern-match">            output.write(buffer, 0, len);</span></span><br><span class="line"><span class="pattern-match">        &#125;</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">        output.flush();</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">        return cipher.<span class="keyword">do</span><span class="constructor">Final(<span class="params">output</span>.<span class="params">toByteArray</span>()</span>);</span></span><br><span class="line"><span class="pattern-match">    &#125; catch (<span class="constructor">Exception</span> e) &#123;</span></span><br><span class="line"><span class="pattern-match">        <span class="constructor">System</span>.err.println(&quot;<span class="constructor">An</span> unknown error on decrypt key: &quot; + e.get<span class="constructor">Message()</span>);</span></span><br><span class="line"><span class="pattern-match">    &#125;</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">    return null;</span></span><br><span class="line"><span class="pattern-match">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a target="_blank" rel="noopener" href="https://security.stackexchange.com/questions/73156/whats-the-difference-between-x-509-and-pkcs7-certificate">https://security.stackexchange.com/questions/73156/whats-the-difference-between-x-509-and-pkcs7-certificate</a><br><a target="_blank" rel="noopener" href="https://security.stackexchange.com/questions/41399/openssl-pkcs7-vs-s-mime">https://security.stackexchange.com/questions/41399/openssl-pkcs7-vs-s-mime</a><br><a target="_blank" rel="noopener" href="https://crypto.stackexchange.com/questions/37084/is-pkcs7-a-signature-format-or-a-certificate-format">https://crypto.stackexchange.com/questions/37084/is-pkcs7-a-signature-format-or-a-certificate-format</a></p>
<p>openssl asn1parse -inform pem -in pkcs7-hash.pem<br><a target="_blank" rel="noopener" href="http://qistoph.blogspot.com/2012/01/manual-verify-pkcs7-signed-data-with.html">Manual verify PKCS#7 signed data with OpenSSL</a></p>

      
    </div>
    <footer>
      
        
        
  
  <div class="tags">
    <a href="/tags/%E5%B7%A5%E4%BD%9C%E6%97%A5%E5%BF%97/">工作日志</a>
  </div>

        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Search">
    <input type="hidden" name="as_sitesearch" value="l1z2g9.github.io">
  </form>
</div>


  

  
<div class="widget tag">
  <h3 class="title">Tags</h3>
  <ul class="entry">
  
    <li><a href="/tags/AIX/">AIX</a><small>29</small></li>
  
    <li><a href="/tags/MySQL/">MySQL</a><small>2</small></li>
  
    <li><a href="/tags/Oracle/">Oracle</a><small>14</small></li>
  
    <li><a href="/tags/Problem-Solve/">Problem Solve</a><small>9</small></li>
  
    <li><a href="/tags/Raspberry-Pi/">Raspberry Pi</a><small>12</small></li>
  
    <li><a href="/tags/%E5%B7%A5%E4%BD%9C%E6%97%A5%E5%BF%97/">工作日志</a><small>70</small></li>
  
    <li><a href="/tags/%E6%97%A5%E5%B8%B8%E8%AE%B0%E5%BD%95/">日常记录</a><small>23</small></li>
  
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2022 Forrest Wan
  
</div>
<div class="clearfix"></div></footer>
  
<script src="/js/jquery-3.4.1.min.js"></script>


<script src="/js/jquery.imagesloaded.min.js"></script>


<script src="/js/gallery.js"></script>





</body>
</html>

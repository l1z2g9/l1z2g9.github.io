<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="utf-8">
  
  <title>Do Something With ElasticSearch | My Blog</title>
  <meta name="author" content="Forrest Wan">
  
  <meta name="description" content="My Blog">
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Do Something With ElasticSearch"/>
  <meta property="og:site_name" content="My Blog"/>

  
    <meta property="og:image" content=""/>
  

  <link rel="shortcut icon" href="/favicon.png">
  
  
<link rel="stylesheet" href="/css/style.css">

  <!--[if lt IE 9]><script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script><![endif]-->
  

<meta name="generator" content="Hexo 6.1.0"></head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">My Blog</a></h1>
  <h2><a href="/"></a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/null">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article id="post-Do-Something-With-ElasticSearch" class="h-entry post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time class="dt-published" datetime="2015-12-11T03:37:44.000Z"><a href="/2015/12/11/Do-Something-With-ElasticSearch/">2015-12-11</a></time>
      
      
  
    <h1 class="p-name title" itemprop="headline name">Do Something With ElasticSearch</h1>
  

    </header>
    <div class="e-content entry" itemprop="articleBody">
      
        <h1 id="elasticsearch-yml-node01-node02"><a href="#elasticsearch-yml-node01-node02" class="headerlink" title="elasticsearch.yml (node01, node02)"></a>elasticsearch.yml (node01, node02)</h1><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">network<span class="selector-class">.host</span>: <span class="variable">$xx</span></span><br><span class="line">http<span class="selector-class">.port</span>: <span class="number">9200</span></span><br><span class="line">transport<span class="selector-class">.tcp</span><span class="selector-class">.port</span>: <span class="number">9300</span></span><br><span class="line">index<span class="selector-class">.number_of_replicas</span>: <span class="number">1</span></span><br><span class="line">discovery:</span><br><span class="line">  zen:</span><br><span class="line">    ping:</span><br><span class="line">      multicast<span class="selector-class">.enabled</span>: false</span><br><span class="line">      unicast<span class="selector-class">.hosts</span>: <span class="selector-attr">[<span class="string">&quot;$yy&quot;</span>]</span></span><br><span class="line">      timeout: <span class="string">&quot;3s&quot;</span></span><br><span class="line">cluster:</span><br><span class="line">  name: es-cluster</span><br><span class="line">node:</span><br><span class="line">  name: <span class="variable">$zz</span></span><br><span class="line">path<span class="selector-class">.repo</span>: <span class="selector-attr">[<span class="string">&quot;/mount/backups&quot;</span>]</span></span><br><span class="line"></span><br><span class="line">index<span class="selector-class">.search</span><span class="selector-class">.slowlog</span><span class="selector-class">.threshold</span><span class="selector-class">.query</span><span class="selector-class">.warn</span>: <span class="number">10s</span></span><br><span class="line">index<span class="selector-class">.search</span><span class="selector-class">.slowlog</span><span class="selector-class">.threshold</span><span class="selector-class">.query</span><span class="selector-class">.info</span>: <span class="number">5s</span></span><br><span class="line">index<span class="selector-class">.search</span><span class="selector-class">.slowlog</span><span class="selector-class">.threshold</span><span class="selector-class">.query</span><span class="selector-class">.debug</span>: <span class="number">2s</span></span><br><span class="line">index<span class="selector-class">.search</span><span class="selector-class">.slowlog</span><span class="selector-class">.threshold</span><span class="selector-class">.query</span><span class="selector-class">.trace</span>: <span class="number">500ms</span></span><br><span class="line"></span><br><span class="line">index<span class="selector-class">.search</span><span class="selector-class">.slowlog</span><span class="selector-class">.threshold</span><span class="selector-class">.fetch</span><span class="selector-class">.warn</span>: <span class="number">1s</span></span><br><span class="line">index<span class="selector-class">.search</span><span class="selector-class">.slowlog</span><span class="selector-class">.threshold</span><span class="selector-class">.fetch</span><span class="selector-class">.info</span>: <span class="number">800ms</span></span><br><span class="line">index<span class="selector-class">.search</span><span class="selector-class">.slowlog</span><span class="selector-class">.threshold</span><span class="selector-class">.fetch</span><span class="selector-class">.debug</span>: <span class="number">500ms</span></span><br><span class="line">index<span class="selector-class">.search</span><span class="selector-class">.slowlog</span><span class="selector-class">.threshold</span><span class="selector-class">.fetch</span><span class="selector-class">.trace</span>: <span class="number">200ms</span></span><br><span class="line"></span><br><span class="line">index<span class="selector-class">.indexing</span><span class="selector-class">.slowlog</span><span class="selector-class">.threshold</span><span class="selector-class">.index</span><span class="selector-class">.warn</span>: <span class="number">10s</span></span><br><span class="line">index<span class="selector-class">.indexing</span><span class="selector-class">.slowlog</span><span class="selector-class">.threshold</span><span class="selector-class">.index</span><span class="selector-class">.info</span>: <span class="number">5s</span></span><br><span class="line">index<span class="selector-class">.indexing</span><span class="selector-class">.slowlog</span><span class="selector-class">.threshold</span><span class="selector-class">.index</span><span class="selector-class">.debug</span>: <span class="number">2s</span></span><br><span class="line">index<span class="selector-class">.indexing</span><span class="selector-class">.slowlog</span><span class="selector-class">.threshold</span><span class="selector-class">.index</span><span class="selector-class">.trace</span>: <span class="number">500ms</span></span><br></pre></td></tr></table></figure>

<p>replace vairable in node01 with ($xx&#x3D;node01, $yy&#x3D;node2, $zz&#x3D;es-node01)<br>replace vairable in node02 with ($xx&#x3D;node02, $yy&#x3D;node1, $zz&#x3D;es-node02)</p>
<h1 id="docker-compose-yml"><a href="#docker-compose-yml" class="headerlink" title="docker-compose.yml"></a>docker-compose.yml</h1><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">elasticsearch:</span><br><span class="line">  build: elasticsearch/</span><br><span class="line">  net: <span class="string">&quot;host&quot;</span></span><br><span class="line">  volumes:</span><br><span class="line">    - .<span class="regexp">/elasticsearch/</span>config:<span class="regexp">/opt/</span>elasticsearch/config:ro</span><br><span class="line">    - <span class="regexp">/var/</span>data:<span class="regexp">/opt/</span>elasticsearch/data</span><br><span class="line">    - <span class="regexp">/opt/</span>backups<span class="regexp">/es_backup:/m</span>ount/backups</span><br><span class="line">  expose:</span><br><span class="line">    - <span class="string">&quot;9200&quot;</span></span><br><span class="line">    - <span class="string">&quot;9300&quot;</span></span><br></pre></td></tr></table></figure>

<h1 id="Install-x2F-Configure-NFS-server-and-client"><a href="#Install-x2F-Configure-NFS-server-and-client" class="headerlink" title="Install&#x2F;Configure NFS server and client"></a>Install&#x2F;Configure NFS server and client</h1><h2 id="In-node02-add-NFS-server"><a href="#In-node02-add-NFS-server" class="headerlink" title="In node02 add NFS server"></a>In node02 add NFS server</h2><p><code>sudo apt-get install nfs-kernel-server</code><br><code>vi /etc/exports</code> to add below setting<br><code>/opt/backups/es_backup node01(rw,sync,no_subtree_check)</code><br>then run <code>exportfs -ra</code></p>
<h2 id="In-node01-add-NFS-client"><a href="#In-node01-add-NFS-client" class="headerlink" title="In node01 add NFS client"></a>In node01 add NFS client</h2><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">sudo</span> apt-<span class="meta">get</span> install nfs-<span class="meta">common</span></span><br><span class="line"><span class="symbol">midir</span> -p /<span class="meta">opt</span>/backups/es_backup</span><br><span class="line"><span class="symbol">mount</span> node02:/<span class="meta">opt</span>/backups/es_backup es_backup</span><br></pre></td></tr></table></figure>
<p><code>vi /etc/fstab</code> to add below setting<br><code>10.13.135.38:/opt/backups/es_backup /opt/backups/es_backup nfs rw,hard,intr 0 0</code></p>
<h1 id="Restart-docker"><a href="#Restart-docker" class="headerlink" title="Restart docker"></a>Restart docker</h1><p>Run command <code>docker-compose up -d</code> to build and run ES.</p>
<h1 id="Create-snapshot-in-ES-with-sense"><a href="#Create-snapshot-in-ES-with-sense" class="headerlink" title="Create snapshot in ES with sense"></a>Create snapshot in ES with sense</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PUT _snapshot/logstash_repo</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;fs&quot;</span>,</span><br><span class="line">    <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;compress&quot;</span>: <span class="string">&quot;true&quot;</span>,</span><br><span class="line">      <span class="string">&quot;location&quot;</span>: <span class="string">&quot;/mount/backups/logstash_repo&quot;</span>,</span><br><span class="line">      <span class="string">&quot;max_snapshot_bytes_per_sec&quot;</span> : <span class="string">&quot;50mb&quot;</span>,</span><br><span class="line">      <span class="string">&quot;max_restore_bytes_per_sec&quot;</span> : <span class="string">&quot;50mb&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Backup-x2F-Restore-indices"><a href="#Backup-x2F-Restore-indices" class="headerlink" title="Backup&#x2F;Restore indices"></a>Backup&#x2F;Restore indices</h1><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">PUT _snapshot<span class="regexp">/logstash_repo/</span>snapshot_20151211</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;indices&quot;</span>: <span class="string">&quot;logstash-2015.12.10,logstash-2015.12.11&quot;</span>,</span><br><span class="line">  <span class="string">&quot;ignore_unavailable&quot;</span>: <span class="string">&quot;true&quot;</span>,</span><br><span class="line">  <span class="string">&quot;include_global_state&quot;</span>: <span class="string">&quot;false&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET <span class="regexp">/_snapshot/</span>logstash_repo<span class="regexp">/_all or GET /</span>_snapshot<span class="regexp">/logstash_repo/</span>snapshot_20151211/_status (Check)</span><br><span class="line"></span><br><span class="line"><span class="keyword">DELETE</span> logstash-<span class="number">2015.12</span>.<span class="number">10</span>,logstash-<span class="number">2015.12</span>.<span class="number">11</span> (<span class="keyword">Delete</span> Indice)</span><br><span class="line"></span><br><span class="line">POST <span class="regexp">/_snapshot/</span>logstash_repo<span class="regexp">/snapshot_20151211/</span>_restore?wait_for_completion (Restore)</span><br><span class="line"></span><br><span class="line"><span class="keyword">DELETE</span> <span class="regexp">/_snapshot/</span>logstash_repo (<span class="keyword">Delete</span> Snapshot)</span><br></pre></td></tr></table></figure>


<h1 id="Following-command-should-be-remembered"><a href="#Following-command-should-be-remembered" class="headerlink" title="Following command should be remembered"></a>Following command should be remembered</h1><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">GET</span> _cluster<span class="built_in">/health</span></span><br><span class="line"><span class="built_in"></span>  <span class="keyword">or</span> <span class="built_in">GET</span> _cluster/health?<span class="attribute">level</span>=indices</span><br><span class="line">  <span class="keyword">or</span> <span class="built_in">GET</span> _cluster/health?<span class="attribute">level</span>=shards</span><br><span class="line">  <span class="keyword">or</span> <span class="built_in">GET</span> _cluster/health?<span class="attribute">wait_for_status</span>=green</span><br><span class="line"></span><br><span class="line"><span class="built_in">GET</span> _cat/indices</span><br><span class="line"></span><br><span class="line"><span class="built_in">GET</span> logstash-2015.12.09/_settings</span><br><span class="line"></span><br><span class="line"><span class="built_in">GET</span> logstash-2015.12.09/_count</span><br><span class="line"></span><br><span class="line"><span class="built_in">GET</span> logstash-2015.12.09/_mapping</span><br><span class="line"></span><br><span class="line"><span class="built_in">GET</span> logstash-2015.12.16/server-SystemOut/_search?<span class="attribute">q</span>=message:Exception</span><br><span class="line"></span><br><span class="line"><span class="built_in">GET</span> logstash-2015.12.08/server-SystemOut/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;message&quot;</span>: <span class="string">&quot;Exception&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">GET</span> logstash-2015.12.15/_search?<span class="attribute">fields</span>=timestamp,host</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;filtered&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;message&quot;</span>: <span class="string">&quot;Exception&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;filter&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;range&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;@timestamp&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;gte&quot;</span>: 1450212195957,</span><br><span class="line">            <span class="string">&quot;lte&quot;</span>: 1450265395957,</span><br><span class="line">            <span class="string">&quot;format&quot;</span>: <span class="string">&quot;epoch_millis&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;sort&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;@timestamp&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;order&quot;</span>: <span class="string">&quot;asc&quot;</span>,</span><br><span class="line">        <span class="string">&quot;unmapped_type&quot;</span>: <span class="string">&quot;boolean&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 10,</span><br><span class="line">  <span class="string">&quot;from&quot;</span>: 0,</span><br><span class="line">  <span class="string">&quot;fields&quot;</span>: [<span class="string">&quot;host&quot;</span>,<span class="string">&quot;message&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">GET</span> logstash-2015.12.15/_search?<span class="attribute">size</span>=20&amp;fields=message</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;query_string&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;query&quot;</span>: <span class="string">&quot;message : Exception AND type : moon01&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Client-API-to-search-ES-cluster"><a href="#Client-API-to-search-ES-cluster" class="headerlink" title="Client API to search ES cluster"></a>Client API to search ES cluster</h1><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">package dh;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.searchbox.client.JestClient;</span><br><span class="line"><span class="keyword">import</span> io.searchbox.client.JestClientFactory;</span><br><span class="line"><span class="keyword">import</span> io.searchbox.client.config.HttpClientConfig;</span><br><span class="line"><span class="keyword">import</span> io.searchbox.core.<span class="keyword">Search</span>;</span><br><span class="line"><span class="keyword">import</span> io.searchbox.core.SearchResult;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Calendar;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.<span class="keyword">index</span>.query.QueryBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.<span class="keyword">index</span>.query.QueryBuilders;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.<span class="keyword">search</span>.builder.SearchSourceBuilder;</span><br><span class="line"></span><br><span class="line"><span class="built_in">public</span> <span class="keyword">class</span> Main &#123;</span><br><span class="line">	<span class="built_in">public</span> static <span class="type">void</span> main(String[] args) throws IOException &#123;</span><br><span class="line">		JestClientFactory factory = <span class="built_in">new</span> JestClientFactory();</span><br><span class="line">		factory.setHttpClientConfig(<span class="built_in">new</span> HttpClientConfig.Builder(&quot;http://10.13.135.37:9200&quot;).build());</span><br><span class="line">		JestClient client = factory.getObject();</span><br><span class="line"></span><br><span class="line">		SearchSourceBuilder builder = <span class="built_in">new</span> SearchSourceBuilder();</span><br><span class="line"></span><br><span class="line">		// single <span class="keyword">and</span> mutilple criteria </span><br><span class="line">		QueryBuilder q1 = QueryBuilders.queryStringQuery(&quot;message : Exception AND type : moon01&quot;);</span><br><span class="line">		QueryBuilder q2 = QueryBuilders.matchQuery(&quot;message&quot;, &quot;Exception&quot;);</span><br><span class="line"></span><br><span class="line">		long now = <span class="keyword">System</span>.currentTimeMillis();</span><br><span class="line">		Calendar c = Calendar.getInstance();</span><br><span class="line">		c.<span class="keyword">set</span>(Calendar.DAY_OF_MONTH, c.<span class="keyword">get</span>(Calendar.DAY_OF_MONTH) - <span class="number">3</span>);</span><br><span class="line">		long thatDay = c.getTimeInMillis();</span><br><span class="line"></span><br><span class="line">		String filtered = builder.query(</span><br><span class="line">				QueryBuilders.filteredQuery(QueryBuilders.queryFilter(q2), QueryBuilders.rangeQuery(&quot;@timestamp&quot;).<span class="keyword">from</span>(</span><br><span class="line">						Long.toString(thatDay)).<span class="keyword">to</span>(Long.toString(now)).format(&quot;epoch_millis&quot;))).sort(&quot;@timestamp&quot;)</span><br><span class="line">				.size(<span class="number">200</span>).<span class="keyword">from</span>(<span class="number">0</span>).field(&quot;_source&quot;).toString();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">System</span>.<span class="keyword">out</span>.println(&quot;DSL Query &quot; + filtered);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">Search</span> <span class="keyword">search</span> = ((<span class="keyword">Search</span>.Builder) <span class="built_in">new</span> <span class="keyword">Search</span>.Builder(filtered).addIndex(&quot;logstash-2015.12.15&quot;).addIndex(</span><br><span class="line">				&quot;logstash-2015.12.16&quot;)).build();</span><br><span class="line">		SearchResult result = (SearchResult) client.<span class="keyword">execute</span>(<span class="keyword">search</span>);</span><br><span class="line"></span><br><span class="line">		List&lt;SearchResult.Hit&lt;<span class="keyword">Log</span>, <span class="type">Void</span>&gt;&gt; hits = result.getHits(<span class="keyword">Log</span>.<span class="keyword">class</span>);</span><br><span class="line"></span><br><span class="line">		<span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">for</span> (SearchResult.Hit&lt;<span class="keyword">Log</span>, <span class="type">Void</span>&gt; hit : hits) &#123;</span><br><span class="line">			i++;</span><br><span class="line">			<span class="keyword">if</span> (hit.source.getWas_message() != <span class="keyword">null</span> &amp;&amp; hit.source.getWas_message().length() &gt; <span class="number">200</span>) &#123;</span><br><span class="line">				<span class="keyword">System</span>.<span class="keyword">out</span>.println(i + &quot; &quot; + hit.<span class="keyword">index</span> + &quot;, &quot; + hit.source.getType() + &quot;, &quot;</span><br><span class="line">						+ hit.source.getWas_message().substring(<span class="number">0</span>, <span class="number">200</span>));</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">System</span>.<span class="keyword">out</span>.println(i + &quot; &quot; + hit.<span class="keyword">index</span> + &quot;, &quot; + hit.source.getType() + &quot;, &quot;</span><br><span class="line">						+ hit.source.getWas_message());</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">System</span>.<span class="keyword">out</span>.println(&quot;Total: &quot; + result.getTotal() + &quot;, Hits size: &quot; + hits.size());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="keyword">Log</span> &#123;</span><br><span class="line">	private String <span class="keyword">type</span>;</span><br><span class="line">	private String was_message;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">public</span> String getType() &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">type</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">public</span> <span class="type">void</span> setType(String <span class="keyword">type</span>) &#123;</span><br><span class="line">		this.<span class="keyword">type</span> = <span class="keyword">type</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">public</span> String getWas_message() &#123;</span><br><span class="line">		<span class="keyword">return</span> was_message;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">public</span> <span class="type">void</span> setWas_message(String was_message) &#123;</span><br><span class="line">		this.was_message = was_message;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Software-installed-in-server"><a href="#Software-installed-in-server" class="headerlink" title="Software installed in server"></a>Software installed in server</h1><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span>:</span></span><br><span class="line">  cowsay</span><br><span class="line">  fortune</span><br><span class="line">  sl</span><br><span class="line">  jq</span><br><span class="line">  banner</span><br><span class="line">  toilet</span><br><span class="line">  figlet</span><br><span class="line">  libaa-bin</span><br><span class="line"></span><br><span class="line">utility:</span><br><span class="line">  htop</span><br><span class="line">  python-pip</span><br><span class="line">  atop</span><br><span class="line">  sysstat</span><br><span class="line"></span><br><span class="line">pip:</span><br><span class="line">  paramiko</span><br><span class="line">  fabric</span><br><span class="line">  elasticsearch</span><br><span class="line"></span><br><span class="line">nfs:</span><br><span class="line">  nfs-common</span><br><span class="line">  nfs-kernel-server</span><br></pre></td></tr></table></figure>

<h1 id="Monitor-docker-with-following-technology"><a href="#Monitor-docker-with-following-technology" class="headerlink" title="Monitor docker with following technology"></a>Monitor docker with following technology</h1><p>Rsyslog<br>ElasticSearch + Logstash + Kibana<br>Graphite<br>Collectd<br>grafana&#x2F;grafana<br>tutum&#x2F;influxdb<br>google&#x2F;cadvisor<br>Heka<br>flunted</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="https://help.ubuntu.com/community/SettingUpNFSHowTo">https://help.ubuntu.com/community/SettingUpNFSHowTo</a></p>

      
    </div>
    <footer>
      
        
        
  
  <div class="tags">
    <a href="/tags/%E6%97%A5%E5%B8%B8%E8%AE%B0%E5%BD%95/">日常记录</a>
  </div>

        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Search">
    <input type="hidden" name="as_sitesearch" value="l1z2g9.github.io">
  </form>
</div>


  

  
<div class="widget tag">
  <h3 class="title">Tags</h3>
  <ul class="entry">
  
    <li><a href="/tags/AIX/">AIX</a><small>29</small></li>
  
    <li><a href="/tags/MySQL/">MySQL</a><small>2</small></li>
  
    <li><a href="/tags/Oracle/">Oracle</a><small>14</small></li>
  
    <li><a href="/tags/Problem-Solve/">Problem Solve</a><small>9</small></li>
  
    <li><a href="/tags/Raspberry-Pi/">Raspberry Pi</a><small>12</small></li>
  
    <li><a href="/tags/%E5%B7%A5%E4%BD%9C%E6%97%A5%E5%BF%97/">工作日志</a><small>69</small></li>
  
    <li><a href="/tags/%E6%97%A5%E5%B8%B8%E8%AE%B0%E5%BD%95/">日常记录</a><small>23</small></li>
  
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2022 Forrest Wan
  
</div>
<div class="clearfix"></div></footer>
  
<script src="/js/jquery-3.4.1.min.js"></script>


<script src="/js/jquery.imagesloaded.min.js"></script>


<script src="/js/gallery.js"></script>





</body>
</html>
